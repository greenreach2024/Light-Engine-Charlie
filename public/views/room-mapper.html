<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room Mapper - Light Engine Charlie</title>
  <link rel="stylesheet" href="../styles.charlie.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #1e293b;
    }

    .mapper-container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }

    .header {
      background: white;
      border-radius: 12px;
      padding: 20px 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin: 0;
      font-size: 28px;
      color: #1e293b;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-secondary {
      background: #64748b;
      color: white;
    }

    .btn-secondary:hover {
      background: #475569;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .main-content {
      display: grid;
      grid-template-columns: 250px 1fr 300px;
      gap: 20px;
    }

    .sidebar, .details-panel {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .sidebar h2, .details-panel h2 {
      margin: 0 0 15px 0;
      font-size: 18px;
      color: #1e293b;
      border-bottom: 2px solid #e2e8f0;
      padding-bottom: 10px;
    }

    .tool-section {
      margin-bottom: 20px;
    }

    .tool-section h3 {
      font-size: 14px;
      color: #64748b;
      margin: 0 0 10px 0;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tool-palette {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .tool-item {
      padding: 12px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      text-align: center;
      cursor: grab;
      transition: all 0.2s;
      user-select: none;
    }

    .tool-item:hover {
      background: #e0e7ff;
      border-color: #3b82f6;
      transform: scale(1.05);
    }

    .tool-item.active {
      background: #dbeafe;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .tool-item:active {
      cursor: grabbing;
    }

    .tool-icon {
      font-size: 28px;
      margin-bottom: 4px;
    }

    .tool-label {
      font-size: 11px;
      font-weight: 600;
      color: #475569;
    }

    .canvas-wrapper {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .canvas-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .canvas-header h2 {
      margin: 0;
      font-size: 18px;
      color: #1e293b;
    }

    .canvas-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .canvas-controls label {
      font-size: 12px;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .canvas-controls input[type="number"] {
      width: 60px;
      padding: 4px 8px;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
    }

    #mapCanvas {
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: crosshair;
      display: block;
      background: #fafafa;
      background-image: 
        linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
    }

    .device-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .device-item {
      padding: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .device-item:hover {
      background: #e0e7ff;
      border-color: #3b82f6;
    }

    .device-item.placed {
      opacity: 0.5;
    }

    .device-info {
      flex: 1;
    }

    .device-name {
      font-size: 13px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 2px;
    }

    .device-type {
      font-size: 11px;
      color: #64748b;
    }

    .device-icon-small {
      font-size: 20px;
      margin-right: 8px;
    }

    .zone-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .zone-item {
      padding: 10px;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      font-weight: 600;
    }

    .details-empty {
      text-align: center;
      color: #94a3b8;
      padding: 40px 20px;
      font-size: 14px;
    }

    .details-content {
      font-size: 13px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f1f5f9;
    }

    .detail-label {
      color: #64748b;
      font-weight: 500;
    }

    .detail-value {
      color: #1e293b;
      font-weight: 600;
    }

    .telemetry-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }

    .telemetry-card {
      background: #f8fafc;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
    }

    .telemetry-label {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 4px;
    }

    .telemetry-value {
      font-size: 18px;
      font-weight: 700;
      color: #1e293b;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
    }

    .action-buttons button {
      flex: 1;
      padding: 8px;
      font-size: 12px;
    }

    .stats-bar {
      background: #f8fafc;
      padding: 12px;
      border-radius: 6px;
      margin-top: 15px;
      font-size: 12px;
      color: #64748b;
    }

    .stats-bar strong {
      color: #1e293b;
    }

    .legend {
      margin-top: 20px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 6px;
    }

    .legend-title {
      font-size: 12px;
      font-weight: 600;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 11px;
      color: #64748b;
    }

    .legend-icon {
      font-size: 16px;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .sidebar, .details-panel {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="mapper-container">
    <!-- Header -->
    <div class="header">
      <div>
        <h1>üó∫Ô∏è Room Mapper</h1>
        <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">Visual layout of sensors, lights, and zones</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="window.location.href='../index.charlie.html'">‚Üê Back to Dashboard</button>
        <button class="btn btn-success" onclick="saveMap()">üíæ Save Map</button>
        <button class="btn btn-primary" onclick="loadMap()">üìÇ Load Map</button>
        <button class="btn btn-danger" onclick="clearMap()">üóëÔ∏è Clear</button>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Left Sidebar: Tools -->
      <div class="sidebar">
        <h2>Tools & Devices</h2>
        
        <!-- Drawing Tools -->
        <div class="tool-section">
          <h3>Drawing Tools</h3>
          <div class="tool-palette">
            <div class="tool-item active" data-tool="select" onclick="selectTool('select')">
              <div class="tool-icon">üëÜ</div>
              <div class="tool-label">Select</div>
            </div>
            <div class="tool-item" data-tool="zone" onclick="selectTool('zone')">
              <div class="tool-icon">üìê</div>
              <div class="tool-label">Draw Zone</div>
            </div>
          </div>
        </div>

        <!-- Available Devices -->
        <div class="tool-section">
          <h3>IoT Devices</h3>
          <div class="device-list" id="deviceList">
            <div style="text-align: center; padding: 20px; color: #94a3b8;">
              Loading devices...
            </div>
          </div>
        </div>

        <!-- Zones -->
        <div class="tool-section">
          <h3>Zones</h3>
          <div class="zone-list" id="zoneList">
            <!-- Populated dynamically -->
          </div>
        </div>

        <!-- Legend -->
        <div class="legend">
          <div class="legend-title">Legend</div>
          <div class="legend-item">
            <span class="legend-icon">üå°Ô∏è</span>
            <span>Temperature/Humidity Sensor</span>
          </div>
          <div class="legend-item">
            <span class="legend-icon">üí°</span>
            <span>Grow Light / Fixture</span>
          </div>
          <div class="legend-item">
            <span class="legend-icon">üåÄ</span>
            <span>Equipment (HVAC, Dehumidifier)</span>
          </div>
          <div class="legend-item">
            <span class="legend-icon">üîå</span>
            <span>Smart Plug / Controller</span>
          </div>
        </div>
      </div>

      <!-- Center: Canvas -->
      <div class="canvas-wrapper">
        <div class="canvas-header">
          <h2>Room Layout</h2>
          <div class="canvas-controls">
            <label>
              Grid:
              <input type="number" id="gridSize" value="20" min="10" max="50" onchange="updateGridSize()">
            </label>
            <label>
              Cell Size:
              <input type="number" id="cellSize" value="40" min="20" max="80" onchange="updateCellSize()">
            </label>
          </div>
        </div>
        <canvas id="mapCanvas" width="800" height="600"></canvas>
        <div class="stats-bar">
          <strong>Grid:</strong> <span id="gridInfo">20√ó15 cells</span> | 
          <strong>Devices:</strong> <span id="deviceCount">0</span> | 
          <strong>Zones:</strong> <span id="zoneCount">0</span>
        </div>
      </div>

      <!-- Right Sidebar: Details -->
      <div class="details-panel">
        <h2>Selection Details</h2>
        <div id="detailsContent" class="details-empty">
          Click on a device or zone<br>to view details
        </div>
      </div>
    </div>
  </div>

  <script src="../app.charlie.js"></script>
  <script>
    // Global state
    const STATE = {
      canvas: null,
      ctx: null,
      gridSize: 20,
      cellSize: 40,
      currentTool: 'select',
      devices: [],
      iotDevices: [],
      placedDevices: [],
      zones: [],
      selectedItem: null,
      isDragging: false,
      draggedItem: null,
      zoneStart: null
    };

    // Device type icons
    const DEVICE_ICONS = {
      sensor: 'üå°Ô∏è',
      woiosensor: 'üå°Ô∏è',
      light: 'üí°',
      plug: 'üîå',
      equipment: 'üåÄ',
      switch: 'üîå',
      default: 'üìç'
    };

    // Zone colors
    const ZONE_COLORS = [
      '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
      '#ec4899', '#06b6d4', '#84cc16', '#f97316'
    ];

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      STATE.canvas = document.getElementById('mapCanvas');
      STATE.ctx = STATE.canvas.getContext('2d');
      
      setupCanvas();
      await loadIoTDevices();
      await loadExistingMap();
      setupEventListeners();
      draw();
    });

    function setupCanvas() {
      const width = STATE.gridSize * STATE.cellSize;
      const height = Math.floor(STATE.gridSize * 0.75) * STATE.cellSize;
      STATE.canvas.width = width;
      STATE.canvas.height = height;
      updateGridInfo();
    }

    function setupEventListeners() {
      STATE.canvas.addEventListener('mousedown', handleMouseDown);
      STATE.canvas.addEventListener('mousemove', handleMouseMove);
      STATE.canvas.addEventListener('mouseup', handleMouseUp);
      STATE.canvas.addEventListener('click', handleClick);
    }

    async function loadIoTDevices() {
      try {
        const response = await fetch('/data/iot-devices.json');
        const devices = await response.json();
        STATE.iotDevices = devices || [];
        renderDeviceList();
      } catch (error) {
        console.error('Failed to load IoT devices:', error);
        document.getElementById('deviceList').innerHTML = 
          '<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load devices</div>';
      }
    }

    function renderDeviceList() {
      const list = document.getElementById('deviceList');
      if (!STATE.iotDevices.length) {
        list.innerHTML = '<div style="text-align: center; padding: 20px; color: #94a3b8;">No devices found</div>';
        return;
      }

      list.innerHTML = '';
      STATE.iotDevices.forEach(device => {
        const isPlaced = STATE.placedDevices.some(p => p.deviceId === device.id);
        const item = document.createElement('div');
        item.className = `device-item ${isPlaced ? 'placed' : ''}`;
        item.dataset.deviceId = device.id;
        
        const icon = getDeviceIcon(device);
        item.innerHTML = `
          <div style="display: flex; align-items: center; flex: 1;">
            <span class="device-icon-small">${icon}</span>
            <div class="device-info">
              <div class="device-name">${device.name || 'Unknown'}</div>
              <div class="device-type">${device.type || 'Unknown'} ${device.zone ? `‚Ä¢ Zone ${device.zone}` : ''}</div>
            </div>
          </div>
        `;
        
        item.addEventListener('click', () => placeDeviceFromList(device));
        list.appendChild(item);
      });
    }

    function getDeviceIcon(device) {
      const type = (device.type || '').toLowerCase();
      const category = (device.category || '').toLowerCase();
      
      if (type.includes('sensor') || category.includes('sensor')) return DEVICE_ICONS.sensor;
      if (type.includes('light') || category.includes('light')) return DEVICE_ICONS.light;
      if (type.includes('plug') || category.includes('plug')) return DEVICE_ICONS.plug;
      if (type.includes('switch')) return DEVICE_ICONS.switch;
      
      return DEVICE_ICONS.default;
    }

    function placeDeviceFromList(device) {
      if (STATE.currentTool !== 'select') {
        selectTool('select');
      }
      
      // Place in center if not already placed
      const isPlaced = STATE.placedDevices.some(p => p.deviceId === device.id);
      if (!isPlaced) {
        const centerX = Math.floor(STATE.gridSize / 2);
        const centerY = Math.floor((STATE.gridSize * 0.75) / 2);
        
        STATE.placedDevices.push({
          deviceId: device.id,
          device: device,
          x: centerX,
          y: centerY,
          icon: getDeviceIcon(device)
        });
        
        renderDeviceList();
        draw();
        updateStats();
        showDetails(STATE.placedDevices[STATE.placedDevices.length - 1]);
      }
    }

    function selectTool(tool) {
      STATE.currentTool = tool;
      document.querySelectorAll('.tool-item').forEach(item => {
        item.classList.remove('active');
      });
      document.querySelector(`[data-tool="${tool}"]`)?.classList.add('active');
      
      STATE.canvas.style.cursor = tool === 'zone' ? 'crosshair' : 'default';
    }

    function handleMouseDown(e) {
      const rect = STATE.canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / STATE.cellSize);
      const y = Math.floor((e.clientY - rect.top) / STATE.cellSize);
      
      if (STATE.currentTool === 'select') {
        // Check if clicking on a device
        const device = STATE.placedDevices.find(d => d.x === x && d.y === y);
        if (device) {
          STATE.isDragging = true;
          STATE.draggedItem = device;
        }
      } else if (STATE.currentTool === 'zone') {
        STATE.zoneStart = { x, y };
      }
    }

    function handleMouseMove(e) {
      if (!STATE.isDragging || !STATE.draggedItem) return;
      
      const rect = STATE.canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / STATE.cellSize);
      const y = Math.floor((e.clientY - rect.top) / STATE.cellSize);
      
      STATE.draggedItem.x = Math.max(0, Math.min(x, STATE.gridSize - 1));
      STATE.draggedItem.y = Math.max(0, Math.min(y, Math.floor(STATE.gridSize * 0.75) - 1));
      
      draw();
    }

    function handleMouseUp(e) {
      if (STATE.currentTool === 'zone' && STATE.zoneStart) {
        const rect = STATE.canvas.getBoundingClientRect();
        const x = Math.floor((e.clientX - rect.left) / STATE.cellSize);
        const y = Math.floor((e.clientY - rect.top) / STATE.cellSize);
        
        if (x !== STATE.zoneStart.x && y !== STATE.zoneStart.y) {
          const zoneNum = STATE.zones.length + 1;
          if (zoneNum <= 9) {
            STATE.zones.push({
              zone: zoneNum,
              name: `Zone ${zoneNum}`,
              color: ZONE_COLORS[(zoneNum - 1) % ZONE_COLORS.length],
              x1: Math.min(STATE.zoneStart.x, x),
              y1: Math.min(STATE.zoneStart.y, y),
              x2: Math.max(STATE.zoneStart.x, x),
              y2: Math.max(STATE.zoneStart.y, y)
            });
            updateZoneList();
            draw();
            updateStats();
          }
        }
        
        STATE.zoneStart = null;
      }
      
      STATE.isDragging = false;
      STATE.draggedItem = null;
    }

    function handleClick(e) {
      if (STATE.isDragging) return;
      
      const rect = STATE.canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left) / STATE.cellSize);
      const y = Math.floor((e.clientY - rect.top) / STATE.cellSize);
      
      // Check for device click
      const device = STATE.placedDevices.find(d => d.x === x && d.y === y);
      if (device) {
        showDetails(device);
        return;
      }
      
      // Check for zone click
      const zone = STATE.zones.find(z => 
        x >= z.x1 && x <= z.x2 && y >= z.y1 && y <= z.y2
      );
      if (zone) {
        showDetails(zone);
      }
    }

    function draw() {
      const ctx = STATE.ctx;
      ctx.clearRect(0, 0, STATE.canvas.width, STATE.canvas.height);
      
      // Draw zones first (background)
      STATE.zones.forEach(zone => {
        ctx.fillStyle = zone.color + '20'; // 20% opacity
        ctx.strokeStyle = zone.color;
        ctx.lineWidth = 2;
        
        const x = zone.x1 * STATE.cellSize;
        const y = zone.y1 * STATE.cellSize;
        const width = (zone.x2 - zone.x1 + 1) * STATE.cellSize;
        const height = (zone.y2 - zone.y1 + 1) * STATE.cellSize;
        
        ctx.fillRect(x, y, width, height);
        ctx.strokeRect(x, y, width, height);
        
        // Draw zone label
        ctx.fillStyle = zone.color;
        ctx.font = 'bold 14px sans-serif';
        ctx.fillText(zone.name, x + 10, y + 25);
      });
      
      // Draw devices (foreground)
      STATE.placedDevices.forEach(device => {
        const x = device.x * STATE.cellSize + STATE.cellSize / 2;
        const y = device.y * STATE.cellSize + STATE.cellSize / 2;
        
        // Draw device icon
        ctx.font = '32px sans-serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(device.icon, x, y);
        
        // Draw device name below
        ctx.font = 'bold 10px sans-serif';
        ctx.fillStyle = '#1e293b';
        ctx.fillText(device.device.name || 'Unknown', x, y + 25);
        
        // Draw zone indicator if assigned
        if (device.device.zone) {
          ctx.fillStyle = '#3b82f6';
          ctx.font = 'bold 9px sans-serif';
          ctx.fillText(`Z${device.device.zone}`, x, y - 20);
        }
      });
    }

    function showDetails(item) {
      STATE.selectedItem = item;
      const content = document.getElementById('detailsContent');
      
      if (item.device) {
        // Device details
        const device = item.device;
        const telemetry = device.telemetry || {};
        
        let html = `
          <div class="details-content">
            <div style="text-align: center; font-size: 32px; margin-bottom: 10px;">${item.icon}</div>
            <div class="detail-row">
              <span class="detail-label">Name</span>
              <span class="detail-value">${device.name || 'Unknown'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Type</span>
              <span class="detail-value">${device.type || 'Unknown'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Protocol</span>
              <span class="detail-value">${device.protocol || 'Unknown'}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Position</span>
              <span class="detail-value">(${item.x}, ${item.y})</span>
            </div>
            ${device.zone ? `
            <div class="detail-row">
              <span class="detail-label">Zone</span>
              <span class="detail-value">Zone ${device.zone}</span>
            </div>
            ` : ''}
        `;
        
        // Add telemetry if available
        if (telemetry.temperature || telemetry.humidity) {
          html += `<div class="telemetry-grid">`;
          if (telemetry.temperature) {
            html += `
              <div class="telemetry-card">
                <div class="telemetry-label">Temperature</div>
                <div class="telemetry-value">${telemetry.temperature}¬∞C</div>
              </div>
            `;
          }
          if (telemetry.humidity) {
            html += `
              <div class="telemetry-card">
                <div class="telemetry-label">Humidity</div>
                <div class="telemetry-value">${telemetry.humidity}%</div>
              </div>
            `;
          }
          html += `</div>`;
        }
        
        html += `
            <div class="action-buttons">
              <button class="btn btn-danger" onclick="removeDevice('${device.id}')">Remove</button>
            </div>
          </div>
        `;
        
        content.innerHTML = html;
      } else if (item.zone) {
        // Zone details
        const html = `
          <div class="details-content">
            <div style="width: 100%; height: 60px; background: ${item.color}; border-radius: 8px; margin-bottom: 15px;"></div>
            <div class="detail-row">
              <span class="detail-label">Zone</span>
              <span class="detail-value">${item.name}</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Position</span>
              <span class="detail-value">(${item.x1}, ${item.y1}) to (${item.x2}, ${item.y2})</span>
            </div>
            <div class="detail-row">
              <span class="detail-label">Size</span>
              <span class="detail-value">${item.x2 - item.x1 + 1} √ó ${item.y2 - item.y1 + 1} cells</span>
            </div>
            <div class="action-buttons">
              <button class="btn btn-danger" onclick="removeZone(${item.zone})">Remove</button>
            </div>
          </div>
        `;
        content.innerHTML = html;
      }
    }

    function removeDevice(deviceId) {
      STATE.placedDevices = STATE.placedDevices.filter(d => d.deviceId !== deviceId);
      STATE.selectedItem = null;
      document.getElementById('detailsContent').innerHTML = '<div class="details-empty">Click on a device or zone<br>to view details</div>';
      renderDeviceList();
      draw();
      updateStats();
    }

    function removeZone(zoneNum) {
      STATE.zones = STATE.zones.filter(z => z.zone !== zoneNum);
      STATE.selectedItem = null;
      document.getElementById('detailsContent').innerHTML = '<div class="details-empty">Click on a device or zone<br>to view details</div>';
      updateZoneList();
      draw();
      updateStats();
    }

    function updateZoneList() {
      const list = document.getElementById('zoneList');
      if (!STATE.zones.length) {
        list.innerHTML = '<div style="text-align: center; padding: 10px; color: #94a3b8; font-size: 12px;">No zones defined</div>';
        return;
      }
      
      list.innerHTML = '';
      STATE.zones.forEach(zone => {
        const item = document.createElement('div');
        item.className = 'zone-item';
        item.style.background = zone.color + '20';
        item.style.borderLeft = `4px solid ${zone.color}`;
        item.innerHTML = `
          <span>${zone.name}</span>
          <span style="font-size: 11px; font-weight: 400;">${(zone.x2 - zone.x1 + 1) * (zone.y2 - zone.y1 + 1)} cells</span>
        `;
        item.addEventListener('click', () => showDetails(zone));
        list.appendChild(item);
      });
    }

    function updateStats() {
      document.getElementById('deviceCount').textContent = STATE.placedDevices.length;
      document.getElementById('zoneCount').textContent = STATE.zones.length;
    }

    function updateGridInfo() {
      const width = STATE.gridSize;
      const height = Math.floor(STATE.gridSize * 0.75);
      document.getElementById('gridInfo').textContent = `${width}x${height} cells`;
    }

    function updateGridSize() {
      STATE.gridSize = parseInt(document.getElementById('gridSize').value);
      setupCanvas();
      draw();
    }

    function updateCellSize() {
      STATE.cellSize = parseInt(document.getElementById('cellSize').value);
      setupCanvas();
      draw();
    }

    async function saveMap() {
      const mapData = {
        roomId: 'default',
        name: 'Main Grow Room',
        gridSize: STATE.gridSize,
        cellSize: STATE.cellSize,
        version: 2,
        devices: STATE.placedDevices.map(d => ({
          deviceId: d.deviceId,
          x: d.x,
          y: d.y,
          snapshot: {
            name: d.device?.name || null,
            type: d.device?.type || null,
            protocol: d.device?.protocol || null,
            category: d.device?.category || null,
            zone: d.device?.zone ?? null,
            icon: d.icon || null
          }
        })),
        zones: STATE.zones,
        lastUpdated: new Date().toISOString()
      };
      
      try {
        const response = await fetch('/data/room-map.json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(mapData)
        });
        
        if (response.ok) {
          alert('‚úÖ Map saved successfully!');
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        console.error('Failed to save map:', error);
        alert('‚ùå Failed to save map. See console for details.');
      }
    }

    async function loadMap() {
      try {
        const response = await fetch('/data/room-map.json');
        if (!response.ok) throw new Error('No saved map found');
        
        const mapData = await response.json();
        await loadExistingMapData(mapData);
        alert('‚úÖ Map loaded successfully!');
      } catch (error) {
        console.error('Failed to load map:', error);
        alert('No saved map found or error loading map.');
      }
    }

    async function loadExistingMap() {
      try {
        const response = await fetch('/data/room-map.json');
        if (response.ok) {
          const mapData = await response.json();
          await loadExistingMapData(mapData);
        }
      } catch (error) {
        console.log('No existing map found, starting fresh');
      }
    }

    async function loadExistingMapData(mapData) {
      if (!STATE.iotDevices.length) {
        await loadIoTDevices();
      }

      STATE.gridSize = mapData.gridSize || 20;
      STATE.cellSize = mapData.cellSize || 40;
      STATE.zones = mapData.zones || [];
      
      document.getElementById('gridSize').value = STATE.gridSize;
      document.getElementById('cellSize').value = STATE.cellSize;
      
      setupCanvas();
      
      // Restore placed devices
      STATE.placedDevices = [];
      if (mapData.devices) {
        for (const devicePos of mapData.devices) {
          const snapshot = devicePos.snapshot || devicePos.metadata || null;
          let device = STATE.iotDevices.find(d => d.id === devicePos.deviceId);

          if (!device && snapshot) {
            device = {
              id: devicePos.deviceId,
              name: snapshot.name || 'Unknown Device',
              type: snapshot.type || 'Unknown',
              protocol: snapshot.protocol || 'Unknown',
              category: snapshot.category || null,
              zone: snapshot.zone ?? null
            };
          }

          const devicePayload = {
            deviceId: devicePos.deviceId,
            device: device || {
              id: devicePos.deviceId,
              name: snapshot?.name || 'Unregistered Device',
              type: snapshot?.type || 'Unknown',
              protocol: snapshot?.protocol || 'Unknown',
              category: snapshot?.category || null,
              zone: snapshot?.zone ?? null
            },
            x: devicePos.x,
            y: devicePos.y,
            icon: snapshot?.icon || (device ? getDeviceIcon(device) : DEVICE_ICONS.default)
          };

          if (!devicePayload.icon) {
            devicePayload.icon = DEVICE_ICONS.default;
          }

          STATE.placedDevices.push(devicePayload);
        }
      }
      
      updateZoneList();
      renderDeviceList();
      draw();
      updateStats();
    }

    function clearMap() {
      if (!confirm('Are you sure you want to clear the entire map?')) return;
      
      STATE.placedDevices = [];
      STATE.zones = [];
      STATE.selectedItem = null;
      
      document.getElementById('detailsContent').innerHTML = '<div class="details-empty">Click on a device or zone<br>to view details</div>';
      
      renderDeviceList();
      updateZoneList();
      draw();
      updateStats();
    }
  </script>
</body>
</html>
