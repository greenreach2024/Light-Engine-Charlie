<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Light Engine Charlie</title>
  <link rel="icon" href="./favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./styles.charlie.css?v=charlie-0.5">
  <script src="./ai-placeholder-replacer.js?v=charlie-0.5" defer></script>
  <script src="./app.charlie.js?v=charlie-0.5" defer></script>
</head>
<body>
  <!-- Static Crystal Gears Splash Screen -->
  <div id="splashOverlay" class="splash-overlay">
    <div id="splash" class="splash" role="img" aria-label="Splash screen image">
      <div class="art" aria-hidden="true">
        <img src="Spash screen clr.png" alt="Splash Screen" class="splash-image">
      </div>
      <div class="caption" role="status" aria-live="polite">Starting Light Engine‚Ä¶</div>
    </div>
  </div>

  <div class="app-layout" id="mainApp" style="display: none;">
    <!-- Persistent sidebar for setup wizards -->
    <!-- Persistent sidebar for setup wizards -->
    <aside class="app-sidebar" id="appSidebar">
      <header class="sidebar-header">
        <div class="sidebar-header__brand">
          <h1 class="sidebar-header__title">Light Engine Charlie</h1>
          <div class="sidebar-header__status">
            <div class="connection-indicator" id="connectionStatus"></div>
            <span id="statusText" class="sidebar-header__status-text">Connecting...</span>
          </div>
        </div>
        <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
          <span class="sidebar-toggle__line"></span>
          <span class="sidebar-toggle__line"></span>
          <span class="sidebar-toggle__line"></span>
        </button>
      </header>

      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <h3 class="sidebar-section__title">Setup</h3>
          <ul class="sidebar-nav__list">
            <li>
              <button class="sidebar-nav__item active" data-target="farm-setup">
                <span class="sidebar-nav__icon">üè≠</span>
                <span class="sidebar-nav__label">Farm Setup</span>
              </button>
            </li>
            <li>
              <button class="sidebar-nav__item" data-target="rooms-setup">
                <span class="sidebar-nav__icon">üè†</span>
                <span class="sidebar-nav__label">Rooms & Zones</span>
              </button>
            </li>
            <li>
              <button class="sidebar-nav__item" data-target="device-setup">
                <span class="sidebar-nav__icon">üí°</span>
                <span class="sidebar-nav__label">Device Setup</span>
              </button>
            </li>
            <li>
              <button class="sidebar-nav__item" data-target="calibration-setup">
                <span class="sidebar-nav__icon">‚öñÔ∏è</span>
                <span class="sidebar-nav__label">Calibration</span>
              </button>
            </li>
          </ul>
        </div>

        <div class="sidebar-section">
          <h3 class="sidebar-section__title">Operations</h3>
          <ul class="sidebar-nav__list">
            <li>
              <button class="sidebar-nav__item" data-target="lights-control">
                <span class="sidebar-nav__icon">üîÜ</span>
                <span class="sidebar-nav__label">Light Control</span>
              </button>
            </li>
            <li>
              <button class="sidebar-nav__item" data-target="schedules-control">
                <span class="sidebar-nav__icon">üìÖ</span>
                <span class="sidebar-nav__label">Schedules</span>
              </button>
            </li>
            <li>
              <button class="sidebar-nav__item" data-target="groups-control">
                <span class="sidebar-nav__icon">üéõÔ∏è</span>
                <span class="sidebar-nav__label">Groups</span>
              </button>
            </li>
          </ul>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="sidebar-footer__stats">
          <div id="deviceCount" class="sidebar-footer__stat"></div>
          <div id="systemStats" class="sidebar-footer__stat"></div>
        </div>
        <button id="saveAll" type="button" class="sidebar-footer__save-btn">Save All</button>
      </div>
    </aside>

    <!-- Main content area -->
    <main class="app-main" id="appMain">
      <!-- Top Farm Branding -->
      <section id="topCard" class="app-header">
        <div class="app-header__brand" id="farmBrandingSection" style="display:none">
          <img id="farmLogo" src="" alt="Farm logo" class="app-header__logo" style="display:none" onerror="this.style.display='none'">
          <div class="app-header__farm-info">
            <h1 id="farmName" class="app-header__farm-name"></h1>
            <div id="farmTagline" class="app-header__farm-tagline"></div>
          </div>
        </div>
        <div class="app-header__status">
          <div id="communicationStatus" class="app-header__comm-status">System Online</div>
        </div>
      </section>

      <!-- Environmental AI Summary -->
      <section id="environmentalAiCard" class="env-summary">
        <div class="env-summary__header">
          <h2 class="env-summary__title">Environmental & AI Features</h2>
          <span class="env-summary__subtitle">Autonomous Growing Intelligence</span>
          <button id="btnOpenEnvModal" type="button" class="env-summary__config-btn">Configure</button>
        </div>
        
        <div class="ai-features-horizontal">
          <!-- SpectraSync Feature -->
          <div class="ai-feature-card active" id="spectraSyncFeature" data-feature="spectrasync">
            <div class="ai-feature-icon spectrasync-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M3 12L6 8L9 14L12 6L15 12L18 4L21 12" stroke="url(#spectrumGradient)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                <defs>
                  <linearGradient id="spectrumGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" style="stop-color:#EF4444"/>
                    <stop offset="33%" style="stop-color:#3B82F6"/>
                    <stop offset="66%" style="stop-color:#E0F2FE"/>
                    <stop offset="100%" style="stop-color:#FEF3C7"/>
                  </linearGradient>
                </defs>
              </svg>
            </div>
            <div class="ai-feature-content">
              <h3>SpectraSync¬Æ</h3>
              <div class="ai-feature-status on">ON</div>
              <div class="ai-feature-description">Real-time spectrum optimization synchronized with plant growth cycles</div>
            </div>
          </div>

          <!-- E.V.I.E Feature -->
          <div class="ai-feature-card" id="evieFeature" data-feature="evie">
            <div class="ai-feature-icon evie-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                <path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
            </div>
            <div class="ai-feature-content">
              <h3>E.V.I.E</h3>
              <div class="ai-feature-status off">OFF</div>
              <div class="ai-feature-description">Environmental Variable Intelligence Engine</div>
            </div>
          </div>

          <!-- VPD Control Feature -->
          <div class="ai-feature-card" id="vpdControlFeature" data-feature="vpdcontrol">
            <div class="ai-feature-icon vpd-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <path d="M17 8L21 12L17 16M7 16L3 12L7 8M14 4L10 20" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
            <div class="ai-feature-content">
              <h3>VPD Control</h3>
              <div class="ai-feature-status off">OFF</div>
              <div class="ai-feature-description">Vapor Pressure Deficit automation</div>
            </div>
          </div>
        </div>

        <div id="envSummary" class="env-summary__metrics">
          <div class="env-metric">
            <div class="env-metric__label">Temperature</div>
            <div class="env-metric__value" id="currentTemp">--¬∞F</div>
          </div>
          <div class="env-metric">
            <div class="env-metric__label">Humidity</div>
            <div class="env-metric__value" id="currentHumidity">--%</div>
          </div>
          <div class="env-metric">
            <div class="env-metric__label">VPD</div>
            <div class="env-metric__value" id="currentVpd">-- kPa</div>
          </div>
        </div>
      </section>

      <!-- Content sections -->
      <div class="content-sections">
        <!-- Setup sections (initially hidden) -->
        <section id="farm-setup" class="content-section" data-section="farm-setup" aria-hidden="false">
          <div class="content-section__header">
            <h2>Farm Setup</h2>
            <p class="content-section__subtitle">Configure your farm profile and growing environment</p>
          </div>
          
          <div id="setupProgressIndicator" class="progress-bar" style="display:none">
            <div class="progress-bar__fill"></div>
          </div>

          <!-- Farm Configuration Card -->
          <div id="farmConfigCard" class="config-card">
            <div class="config-card__header">
              <div class="config-card__icon">üè°</div>
              <div class="config-card__title">
                <h3>Farm Profile</h3>
                <p class="config-card__description">Set up your farm's basic information and branding</p>
              </div>
              <div class="config-card__status" id="farmStatus">
                <span class="status-badge status-badge--pending">Not Configured</span>
              </div>
            </div>
            
            <div class="config-card__content">
              <div id="farmSummary" class="summary-display" aria-live="polite">
                <div class="summary-placeholder">
                  <p>Complete the farm setup wizard to configure your growing operation.</p>
                  <ul class="setup-checklist">
                    <li>üå± Farm name and branding</li>
                    <li>üè† Facility information</li>
                    <li>üå°Ô∏è Environmental preferences</li>
                    <li>üë• Team and contact details</li>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="config-card__actions">
              <button id="btnOpenFarmModal" type="button" class="primary">
                <span class="btn-icon">‚öôÔ∏è</span>
                Setup Farm Wizard
              </button>
              <button id="btnEditFarm" type="button" class="secondary" style="display:none">
                <span class="btn-icon">‚úèÔ∏è</span>
                Edit Profile
              </button>
              <button id="btnFarmPreview" type="button" class="ghost" style="display:none">
                <span class="btn-icon">üëÅÔ∏è</span>
                Preview
              </button>
            </div>
            
            <div class="config-card__footer">
              <div class="status-info">
                <span id="farmModalStatus" class="status-text" aria-live="polite"></span>
              </div>
              <div class="last-updated" id="farmLastUpdated" style="display:none">
                <span class="tiny">Last updated: Never</span>
              </div>
            </div>
          </div>

          <!-- Environment Configuration Card -->
          <div id="environmentCard" class="config-card">
            <div class="config-card__header">
              <div class="config-card__icon">üå°Ô∏è</div>
              <div class="config-card__title">
                <h3>Environment Settings</h3>
                <p class="config-card__description">Configure environmental monitoring and automation</p>
              </div>
              <div class="config-card__status" id="environmentStatus">
                <span class="status-badge status-badge--pending">Not Configured</span>
              </div>
            </div>
            
            <div class="config-card__content">
              <div id="environmentSummary" class="summary-display" aria-live="polite">
                <div class="summary-placeholder">
                  <p>Environment settings will be configured after farm profile setup.</p>
                  <div class="env-preview">
                    <div class="env-metric">
                      <span class="env-label">Target Temperature:</span>
                      <span class="env-value">--¬∞F</span>
                    </div>
                    <div class="env-metric">
                      <span class="env-label">Target Humidity:</span>
                      <span class="env-value">--%</span>
                    </div>
                    <div class="env-metric">
                      <span class="env-label">VPD Range:</span>
                      <span class="env-value">-- kPa</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="config-card__actions">
              <button id="btnOpenEnvModal" type="button" class="secondary">
                <span class="btn-icon">üå°Ô∏è</span>
                Configure Environment
              </button>
            </div>
          </div>
        </section>

        <section id="rooms-setup" class="content-section" data-section="rooms-setup" aria-hidden="true">
          <div class="content-section__header">
            <h2>Rooms & Zones</h2>
            <p class="content-section__subtitle">Organize your growing spaces by rooms and zones</p>
          </div>

          <div id="roomsPanel" class="setup-panel">
            <h3>Rooms Management</h3>
            <p class="setup-panel__description">Set up rooms and their growing zones for optimal organization</p>
            <div class="row gap8-mb12">
              <button id="btnOpenRoomsModal" type="button" class="primary">Manage Rooms</button>
              <span id="roomsModalStatus" class="tiny" aria-live="polite"></span>
            </div>
            <div id="roomsSummary" class="summary-display" aria-live="polite"></div>
          </div>
        </section>

        <section id="device-setup" class="content-section" data-section="device-setup" aria-hidden="true">
          <div class="content-section__header">
            <h2>Device Setup</h2>
            <p class="content-section__subtitle">Discover, configure, and assign your grow lights and IoT devices</p>
          </div>

          <div id="lightsStatusPanel" class="setup-panel">
            <div class="device-status-banner" id="warningBanner" style="display:none">
              <div class="device-status-banner__content">
                <span id="warningText">System Status</span>
              </div>
            </div>

            <div class="device-discovery-section">
              <h3>Light Discovery & Status</h3>
              <p class="setup-panel__description">Discover new GreenReach lights and view their current status</p>
              <div class="row gap8-mb12">
                <button id="btnFreshLight" type="button" class="primary">Fresh Light Discovery</button>
                <button id="btnDiscoverLights" type="button" class="ghost">Targeted Light Scan</button>
                <span id="lightsStatus" class="tiny" aria-live="polite"></span>
              </div>
              <div id="lightsSummary" class="summary-display" aria-live="polite"></div>
            </div>
          </div>

          <div id="lightsPanel" class="setup-panel">
            <h3>Light Assignment</h3>
            <p class="setup-panel__description">Assign discovered lights to specific rooms and zones</p>
            <div class="row gap8-mb12">
              <button id="btnOpenLightsModal" type="button" class="primary">Manage Light Assignments</button>
              <span id="lightsModalStatus" class="tiny" aria-live="polite"></span>
            </div>
            <div id="lightsAssignmentSummary" class="summary-display" aria-live="polite"></div>
          </div>

          <div id="controllerAssignmentsPanel" class="setup-panel">
            <h3>Controller Configuration</h3>
            <p class="setup-panel__description">Set up and configure controllers for automated operations</p>
            <div class="row gap8-mb12">
              <button id="btnOpenControllerModal" type="button" class="primary">Configure Controllers</button>
              <span id="controllersStatus" class="tiny" aria-live="polite"></span>
            </div>
            <div id="controllersSummary" class="summary-display" aria-live="polite"></div>
          </div>

          <div id="iotPanel" class="setup-panel">
            <h3>IoT Device Management</h3>
            <p class="setup-panel__description">Configure and monitor your IoT devices including SwitchBot environmental sensors, Kasa smart plugs, Shelly relays, and GreenReach grow lights</p>
            <div class="row gap8-mb12">
              <button id="btnDiscover" type="button" class="primary" title="Mock device discovery">Discover new GreenReach Devices</button>
              <button id="btnOpenSwitchBotManager" type="button" class="ghost">Open Device Manager</button>
              <button id="btnRefreshSwitchBot" type="button" class="ghost">Refresh</button>
            </div>
            <div id="switchbotDevicesList" class="devices-list">
              <!-- IoT devices will be loaded here -->
            </div>
          </div>
        </section>

        <section id="calibration-setup" class="content-section" data-section="calibration-setup" aria-hidden="true">
          <div class="content-section__header">
            <h2>Calibration</h2>
            <p class="content-section__subtitle">Match lights to a target using controller or meter readings</p>
          </div>

          <div class="setup-panel">
            <h3>Light Calibration</h3>
            <p class="setup-panel__description">Pick a scope (Light, Group, or Location), choose a target light, and preview corrections before applying. Calibrations store per-light gains that wrap all future writes.</p>
            <div class="row gap8-mb12">
              <button id="btnOpenCalWizard" type="button" class="primary">Open Calibration Wizard</button>
              <span id="calStatus" class="tiny" aria-live="polite"></span>
            </div>
          </div>
        </section>

        <!-- Operations sections (initially visible) -->
        <section id="lights-control" class="content-section" data-section="lights-control">
          <div class="content-section__header">
            <h2>Light Control</h2>
            <p class="content-section__subtitle">Direct control and monitoring of your grow lights</p>
          </div>

          <div id="plansPanel" class="control-panel">
            <div class="control-panel__header">
              <h3>
                Light Plans
                <span class="hint" tabindex="0" data-tip="Pre-configured light spectra for different growth phases. Apply plans manually or through schedules.">?</span>
              </h3>
              <button id="btnOpenPlansModal" type="button" class="ghost">Manage Plans</button>
            </div>
            <p class="control-panel__description">Select and apply pre-configured lighting plans for different growth phases</p>
            <div id="plansSelector" class="plans-selector">
              <!-- Plans will be loaded here -->
            </div>
          </div>
        </section>

        <section id="schedules-control" class="content-section" data-section="schedules-control" aria-hidden="true">
          <div class="content-section__header">
            <h2>Schedules</h2>
            <p class="content-section__subtitle">Automated timing and scheduling for your grow operations</p>
          </div>

          <div id="schedulesPanel" class="control-panel">
            <div class="control-panel__header">
              <h3>
                Schedule Management
                <span class="hint" tabindex="0" data-tip="Automate your lighting and environmental controls with time-based schedules.">?</span>
              </h3>
              <button id="btnOpenSchedulesModal" type="button" class="ghost">Manage Schedules</button>
            </div>
            <p class="control-panel__description">Create and manage automated schedules for lighting, environmental controls, and more</p>
            <div id="schedulesSelector" class="schedules-selector">
              <!-- Schedules will be loaded here -->
            </div>
          </div>
        </section>

        <section id="groups-control" class="content-section" data-section="groups-control" aria-hidden="true">
          <div class="content-section__header">
            <h2>Groups</h2>
            <p class="content-section__subtitle">Collective control of multiple lights and devices</p>
          </div>

          <div id="groupsPanel" class="control-panel">
            <div class="control-panel__header">
              <h3>
                Group Control
                <span class="hint" tabindex="0" data-tip="Control multiple lights as a group. Create custom spectra and apply to all group members simultaneously.">?</span>
              </h3>
              <div class="control-panel__actions">
                <button id="btnOpenGroupsModal" type="button" class="ghost">Manage Groups</button>
              </div>
            </div>
            <p class="control-panel__description">Create and control groups of lights for synchronized operation</p>

            <div id="groupsSelector" class="groups-selector" style="margin-bottom:16px">
              <!-- Groups will be loaded here -->
            </div>

            <div id="groupControlSection" class="group-control-section" style="display:none">
              <!-- Spectrum sliders -->
              <div id="groupSpectrum" class="spectrum-control">
                <div class="spectrum-control__sliders">
                  <!-- Color sliders will be added here -->
                </div>
                <div class="spectrum-control__actions">
                  <button id="grpOff" type="button" class="ghost">Power OFF</button>
                  <button id="grpApply" type="button" class="primary">Apply Spectrum</button>
                </div>
                <p id="groupLastHex" class="spectrum-control__last-hex"></p>
              </div>

              <!-- Twin spectrum preview beside sliders: HUD mix and Plan mix -->
              <div id="groupTwinSpectra" class="spectrum-previews">
                <div class="device-spectrum">
                  <div class="device-spectrum__title">Current mix</div>
                  <canvas id="groupHudCanvas" class="device-spectrum__canvas"></canvas>
                </div>
                <div class="device-spectrum">
                  <div class="device-spectrum__title">Plan spectrum</div>
                  <canvas id="groupPlanCanvas" class="device-spectrum__canvas"></canvas>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Primary Farm Wizard Modal -->
  <div id="farmModal" class="farm-modal" aria-hidden="true">
    <div class="farm-modal__backdrop" id="farmModalBackdrop"></div>
    <div class="farm-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="farmModalTitle">
      <header class="farm-modal__header">
        <div>
          <h2 id="farmModalTitle">Farm Setup Wizard</h2>
          <p class="farm-modal__subtitle">Configure your growing operation step by step</p>
          <div id="farmModalProgress" class="tiny" aria-live="polite"></div>
        </div>
        <button type="button" id="farmModalClose" class="farm-modal__close" aria-label="Close">√ó</button>
      </header>
      
      <form id="farmWizardForm" class="farm-form">
        <nav class="farm-wizard-breadcrumbs" aria-label="Wizard progress">
          <ol id="farmWizardCrumbs" class="wizard-crumbs">
            <li data-step-ref="wifi" class="is-active">Wi‚ÄëFi</li>
            <li data-step-ref="contact">Contact</li>
            <li data-step-ref="profile">Profile</li>
            <li data-step-ref="branding">Branding</li>
            <li data-step-ref="location">Location</li>
            <li data-step-ref="rooms">Rooms</li>
            <li data-step-ref="review">Review</li>
          </ol>
        </nav>
        <div class="farm-steps">
          <section class="farm-step active" data-step="profile">
            <p class="farm-question">What's your farm called?</p>
            <div class="farm-step__stack">
              <input id="farmNameInput" type="text" placeholder="Farm name (e.g., Green Valley Grows)" class="farm-input" required>
              <input id="farmTaglineInput" type="text" placeholder="Tagline (optional)" class="farm-input">
              <div class="logo-upload">
                <label for="farmLogoInput" class="logo-upload__label">Farm Logo (optional)</label>
                <input id="farmLogoInput" type="file" accept="image/*" class="logo-upload__input">
                <div id="logoPreview" class="logo-preview"></div>
              </div>
            </div>
          </section>
          <section class="farm-step" data-step="wifi">
            <p class="farm-question">Connect Charlie to your farm Wi‚ÄëFi</p>
            <div class="farm-step__stack">
              <div>
                <button id="btnScanWifi" type="button" class="ghost">Scan networks</button>
                <div id="wifiNetworksList" class="tiny" style="margin-top:8px"></div>
              </div>
              <div class="grid-2col-gap8-mid">
                <input id="manualSsid" type="text" placeholder="Network name (SSID)" class="farm-input">
                <div class="flex-gap8-center">
                  <input id="wifiPassword" type="password" placeholder="Wi‚ÄëFi password" class="farm-input flex1">
                  <label class="tiny"><input id="wifiShowPassword" type="checkbox"> Show</label>
                </div>
              </div>
              <div class="flex-gap8-center">
                <button id="btnTestWifi" type="button" class="primary">Test connection</button>
                <div id="wifiTestResult" class="tiny" aria-live="polite"></div>
              </div>
            </div>
          </section>
          <section class="farm-step" data-step="contact">
            <p class="farm-question">Who should we contact for this farm?</p>
            <div class="farm-step__stack">
              <input id="contactName" type="text" placeholder="Full name" class="farm-input">
              <input id="contactEmail" type="email" placeholder="Email" class="farm-input">
              <input id="contactPhone" type="tel" placeholder="Phone" class="farm-input">
              <input id="contactWebsite" type="text" placeholder="Website (yourdomain.com)" class="farm-input">
            </div>
          </section>
          <section class="farm-step" data-step="location">
            <p class="farm-question">Where is your farm located?</p>
            <div class="farm-step__stack">
              <input id="farmAddress" type="text" placeholder="Street address" class="farm-input">
              <div class="grid-2col-gap8">
                <input id="farmCity" type="text" placeholder="City" class="farm-input">
                <input id="farmState" type="text" placeholder="State / Province" class="farm-input">
              </div>
              <div class="grid-2col-gap8-mid">
                <input id="farmPostal" type="text" placeholder="Postal / ZIP" class="farm-input">
                <select id="farmTimezone" class="farm-input"></select>
              </div>
              <div>
                <button id="btnUseMyLocation" type="button" class="ghost">Use my current location</button>
              </div>
            </div>
          </section>
          <section class="farm-step" data-step="branding">
            <p class="farm-question">Make it yours ‚Äî colors and style</p>
            <div class="farm-step__stack">
              <div class="grid-2col-gap8-mid">
                <label class="tiny">Primary Color <input id="primaryColor" type="color" class="farm-input h40" value="#0077b5"></label>
                <label class="tiny">Accent Color <input id="accentColor" type="color" class="farm-input h40" value="#af9b62"></label>
              </div>
              <div>
                <button id="btnBrandingPreview" type="button" class="ghost">Preview branding</button>
              </div>
            </div>
          </section>
          <section class="farm-step" data-step="rooms">
            <p class="farm-question">Add your spaces‚Äîrooms first, then zones within each room.</p>
            <div class="farm-step__stack">
              <div class="add-room-form">
                <input id="newRoomName" type="text" placeholder="Room name (e.g., Flower A)" class="farm-input">
                <button id="btnAddRoom" type="button" class="ghost">Add room</button>
              </div>
              <div id="roomsEditor" class="farm-spaces" aria-live="polite"></div>
            </div>
          </section>
          <section class="farm-step" data-step="review">
            <p class="farm-question">Farm ¬∑ Rooms ¬∑ Zones ‚Äî ready to save?</p>
            <div class="farm-review" id="farmReview"></div>
          </section>
        </div>
        <div class="farm-form__actions">
          <button id="farmPrev" type="button" class="ghost">Back</button>
          <div class="farm-form__primary-actions">
            <button id="farmNext" type="button" class="primary">Next</button>
            <button id="btnSaveFarm" type="submit" class="primary" style="display:none">Save Farm</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="deviceManager" class="device-manager" aria-hidden="true">
    <div class="device-manager__backdrop" id="deviceManagerBackdrop"></div>
    <div class="device-manager__window" role="dialog" aria-modal="true" aria-labelledby="deviceManagerTitle">
      <header class="device-manager__header">
        <div>
          <h2 id="deviceManagerTitle">Device Manager</h2>
          <p class="device-manager__subtitle">Scan Wi‚ÄëFi, BLE, and MQTT sources to bring devices into the farm.</p>
        </div>
        <button type="button" id="deviceManagerClose" class="ghost" aria-label="Close">√ó</button>
      </header>
      <div class="device-manager__toolbar">
        <button id="btnRunDiscovery" type="button" class="primary">Run discovery</button>
        <span id="discoveryStatus" class="discovery-status" aria-live="polite"></span>
        <div class="chip-row" role="tablist" aria-label="Discovery filters">
          <button type="button" class="chip-option" data-filter="all" aria-selected="true">All</button>
          <button type="button" class="chip-option" data-filter="added">Added</button>
          <button type="button" class="chip-option" data-filter="ignored">Ignored</button>
        </div>
      </div>
      <div id="deviceDiscoveryResults" class="device-manager__results" aria-live="polite"></div>
      <footer class="device-manager__footer">
        <div id="deviceManagerSummary" class="device-manager__summary"></div>
        <button id="btnOpenAutomation" type="button" class="ghost">Open Automation Card</button>
      </footer>
    </div>
  </div>

  <footer id="planSummary" class="app-footer"></footer>
  <div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>
  </div> <!-- End app-layout -->

  <!-- Environment Modal (for Configure Environment) -->
  <div id="envModal" class="env-modal" aria-hidden="true">
    <div class="env-modal__backdrop" id="envModalBackdrop"></div>
    <div class="env-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="envModalTitle">
      <button type="button" class="env-modal__close" id="envModalClose" aria-label="Close">√ó</button>
      <div class="env-modal__content">
        <h2 id="envModalTitle" style="margin:0 0 12px">Trend</h2>
        <p class="tiny" id="envModalSubtitle" style="margin:0 0 12px;color:#475569"></p>
        <div id="envModalChart" class="env-modal__chart"></div>
        <div id="envModalStats" class="env-modal__stats"></div>
        <p class="tiny" style="margin-top:12px;color:#64748b">
          Tip: Click any environment metric card to open a detailed trend view here.
        </p>
      </div>
    </div>
  </div>

  <!-- Room Modal -->
  <div id="roomModal" class="room-modal" aria-hidden="true">
    <div class="room-modal__backdrop" id="roomModalBackdrop"></div>
    <div class="room-modal__window" role="dialog" aria-modal="true" aria-labelledby="roomModalTitle">
      <header class="room-modal__header">
        <div>
          <h2 id="roomModalTitle">Room Setup Wizard</h2>
          <p class="room-modal__subtitle">Configure your room and zones</p>
        </div>
        <button type="button" id="roomModalClose" class="room-modal__close" aria-label="Close">√ó</button>
      </header>
      <div class="room-modal__content">
        <p>Room wizard functionality coming soon...</p>
        <button type="button" id="roomModalClose2" class="primary">Close</button>
      </div>
    </div>
  </div>

  <!-- Light Modal -->
  <div id="lightModal" class="light-modal" aria-hidden="true">
    <div class="light-modal__backdrop" id="lightModalBackdrop"></div>
    <div class="light-modal__window" role="dialog" aria-modal="true" aria-labelledby="lightModalTitle">
      <header class="light-modal__header">
        <div>
          <h2 id="lightModalTitle">Light Setup Wizard</h2>
          <p class="light-modal__subtitle">Configure lighting devices and assignments</p>
        </div>
        <button type="button" id="lightModalClose" class="light-modal__close" aria-label="Close">√ó</button>
      </header>
      <div class="light-modal__content">
        <p>Light wizard functionality coming soon...</p>
        <button type="button" id="lightModalClose2" class="primary">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Static Splash Screen Controller
    (() => {
      const splash = document.getElementById('splash');
      const overlay = document.getElementById('splashOverlay');
      const mainApp = document.getElementById('mainApp');
      
      // Simple timing - show for 2 seconds then fade out
      const displayTime = 2000; // 2 seconds
      const fadeTime = 500;     // 0.5 second fade
      
      // Handle splash screen completion
      const completeSplash = () => {
        // Add fade out animation
        overlay.classList.add('autohide');
        
        // After fade completes, show main app
        setTimeout(() => {
          overlay.style.display = 'none';
          mainApp.style.display = 'block';
          mainApp.style.opacity = '0';
          mainApp.style.transition = 'opacity 0.5s ease-in';
          
          setTimeout(() => {
            mainApp.style.opacity = '1';
          }, 50);
          
          console.log('Light Engine Charlie - Main application loaded');
        }, fadeTime);
      };
      
      // Auto-complete splash after display time
      setTimeout(() => {
        if (!splash.classList.contains('skipped')) {
          completeSplash();
        }
      }, displayTime);
      
      // Allow click/tap to skip
      overlay.addEventListener('click', () => {
        splash.classList.add('skipped');
        setTimeout(completeSplash, 100);
      });
      
      // Keyboard accessibility
      document.addEventListener('keydown', (e) => {
        if (e.key === 's' || e.key === 'S' || e.key === 'Enter' || e.key === ' ') {
          if (overlay.style.display !== 'none' && !splash.classList.contains('skipped')) {
            e.preventDefault();
            splash.classList.add('skipped');
            setTimeout(completeSplash, 100);
          }
        }
      });
      
      // Make overlay focusable for keyboard users
      overlay.setAttribute('tabindex', '0');
      overlay.setAttribute('role', 'button');
      overlay.setAttribute('aria-label', 'Crystal gears loading screen. Press Enter, Space, or S to continue.');
      
      // Handle reduced motion preference
      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
        // Skip to main app immediately for reduced motion users
        setTimeout(completeSplash, 500);
      }
    })();
  </script>
</body>
</html>