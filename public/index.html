<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Light Engine Charlie</title>
  <link rel="stylesheet" href="./styles.charlie.css?v=charlie-0.5">
  <script src="./app.charlie.js?v=charlie-0.5" defer></script>
</head>
<body>
  <!-- Top Card with Farm Info and Status -->
  <section id="topCard" class="card" style="margin:12px;padding:24px;border-radius:12px;background:var(--gr-surface);box-shadow:var(--gr-shadow);min-height:120px">
    <div class="row" style="justify-content:space-between;align-items:center;height:100%">
      <!-- Left side: Farm branding -->
      <div class="row" style="align-items:center;gap:16px;flex:1">
        <img id="farmLogo" src="" alt="Farm logo" style="width:48px;height:48px;border-radius:8px;display:none" onerror="this.style.display='none'">
        <div id="farmBrandingSection" style="display:none">
          <h1 id="farmName" style="margin:0;font-size:24px;font-weight:700;line-height:1.2"></h1>
          <div id="farmTagline" class="tiny" style="margin-top:4px;opacity:0.8"></div>
        </div>
      </div>
      
      <!-- Right side: Light Engine Charlie and controls -->
      <div class="row" style="align-items:center;gap:20px">
        <div style="text-align:right">
          <h1 id="lightEngineTitle" style="margin:0;font-size:20px;font-weight:300;color:var(--gr-primary);font-family:'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;letter-spacing:0.5px">
            Light Engine Charlie
          </h1>
          <div id="communicationStatus" class="tiny" style="color:var(--medium);margin-top:4px;text-align:right">System Online</div>
        </div>
        <label class="row" style="align-items:center;gap:8px;background:rgba(var(--gr-primary-rgb, 13, 125, 125), 0.05);padding:8px 12px;border-radius:8px;border:1px solid rgba(var(--gr-primary-rgb, 13, 125, 125), 0.1)">
          <input id="researchModeToggle" type="checkbox" style="width:18px;height:18px" />
          <span class="tiny" style="font-weight:500;color:var(--gr-primary)">Research Mode</span>
        </label>
      </div>
    </div>
  </section>

  <!-- Environmental / AI Feature Card -->
  <section id="environmentalAiCard" class="card" style="margin:0 12px 12px 12px;padding:20px;border-radius:12px;background:var(--gr-surface);box-shadow:var(--gr-shadow);min-height:90px;overflow:visible">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:16px">
      <h2 style="margin:0;font-size:16px;font-weight:600;color:var(--gr-text)">Environmental & AI Features</h2>
      <span class="tiny" style="color:var(--medium)">Autonomous Growing Intelligence</span>
    </div>
    
    <div class="ai-features-horizontal">
      <!-- SpectraSync Feature -->
      <div class="ai-feature-card active" id="spectraSyncFeature" data-feature="spectrasync">
        <div class="ai-feature-icon spectrasync-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M3 12L6 8L9 14L12 6L15 12L18 4L21 12" stroke="url(#spectrumGradient)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <defs>
              <linearGradient id="spectrumGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#EF4444"/>
                <stop offset="33%" style="stop-color:#3B82F6"/>
                <stop offset="66%" style="stop-color:#E0F2FE"/>
                <stop offset="100%" style="stop-color:#FEF3C7"/>
              </linearGradient>
            </defs>
          </svg>
        </div>
        <div class="ai-feature-content">
          <h3>SpectraSync®</h3>
          <div class="ai-feature-status on">ON</div>
          <div class="ai-feature-description">Real-time spectrum optimization synchronized with plant growth cycles</div>
        </div>
      </div>

      <!-- E.V.I.E Feature -->
      <div class="ai-feature-card" id="evieFeature" data-feature="evie">
        <div class="ai-feature-icon evie-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
            <path d="M8 12L10 14L12 10L14 14L16 12" fill="currentColor" opacity="0.3"/>
            <circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.6"/>
          </svg>
        </div>
        <div class="ai-feature-content">
          <h3>E.V.I.E</h3>
          <div class="ai-feature-status off">OFF</div>
          <div class="ai-feature-description">Environmental Virtual Intelligence Engine for autonomous climate control</div>
        </div>
      </div>

      <!-- IA In Training Feature -->
      <div class="ai-feature-card active" id="iaTrainingFeature" data-feature="ia-training">
        <div class="ai-feature-icon ia-training-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <polygon points="12,2 22,20 2,20" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M12 8L12 14" stroke="currentColor" stroke-width="1.5"/>
            <circle cx="12" cy="16" r="1" fill="currentColor"/>
            <circle cx="8" cy="18" r="1" fill="currentColor" opacity="0.3"/>
            <circle cx="16" cy="18" r="1" fill="currentColor" opacity="0.3"/>
          </svg>
        </div>
        <div class="ai-feature-content">
          <h3>IA In Training</h3>
          <div class="ai-feature-status always-on">ALWAYS ON</div>
          <div class="ai-feature-description">Intelligent Agent continuously learning from farm operations and outcomes</div>
        </div>
      </div>

      <!-- IA Assist Feature -->
      <div class="ai-feature-card active" id="iaAssistFeature" data-feature="ia-assist">
        <div class="ai-feature-icon ia-assist-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M12 2L15 9L22 9L17 14L19 22L12 18L5 22L7 14L2 9L9 9L12 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M12 8L12 14" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </div>
        <div class="ai-feature-content">
          <h3>IA Assist</h3>
          <div class="ai-feature-status always-on">ALWAYS ON</div>
          <div class="ai-feature-description">AI-powered recommendations and automated decision support system</div>
        </div>
      </div>

      <!-- Environmental Impact Index Feature -->
      <div class="ai-feature-card" id="eiiFeature" data-feature="eii">
        <div class="ai-feature-icon eii-icon">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
            <path d="M8 12L10 10L12 14L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="1" fill="currentColor"/>
          </svg>
        </div>
        <div class="ai-feature-content">
          <h3>E.I²</h3>
          <div class="ai-feature-status dev">DEV</div>
          <div class="ai-feature-description">Environmental Impact Index measuring sustainability metrics and carbon footprint</div>
        </div>
      </div>
    </div>
  </section>

  <div id="tooltip" role="tooltip" aria-hidden="true"><div class="tip-arrow"></div><div id="tooltip-content"></div></div>

  <main style="padding:12px">
    <noscript>
      <div class="card" style="border:1px solid #f59e9e;background:#fff5f5;color:#7f1d1d;padding:10px;border-radius:8px;margin-bottom:12px">
        JavaScript is disabled. Enable it to load the dashboard UI.
      </div>
    </noscript>

    <!-- Current Lights Status Panel -->
    <section id="lightsStatusPanel" class="card" style="border:1px solid #eee;border-radius:10px;padding:12px;margin-bottom:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Current Lights Status
          <span class="hint" tabindex="0" data-tip="Aggregates SwitchBot, Kasa, and registered fixtures. Uses cached cloud/device data by default to avoid rate limits.">?</span>
        </h2>
        <div class="row" style="gap:6px;align-items:center">
          <button id="btnRefreshLights" type="button" class="ghost">Refresh</button>
        </div>
      </div>
      <p id="lightsStatusSummary" class="tiny" aria-live="polite" style="color:#64748b;margin:6px 0">Loading…</p>
      <div id="lightsStatusList" class="grid cols-3" style="gap:8px"></div>
    </section>

    <!-- Farm Registration Panel (moved above Grow Rooms) -->
    <section id="farmPanel" class="card" style="border:1px solid #eee;border-radius:10px;padding:12px;margin-bottom:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Farm Registration
          <span class="hint" tabindex="0" data-tip="Guided setup to get the reTerminal online, capture the farm address, and map Rooms/Zones. We save as we go and collapse to a summary badge when complete.">?</span>
        </h2>
        <div class="row" style="gap:6px">
          <button id="btnLaunchFarm" type="button" class="primary">Register Farm</button>
          <button id="btnEditFarm" type="button" class="ghost" style="display:none">Edit</button>
        </div>
      </div>
      <p class="tiny" style="margin:8px 0 0;color:#475569">Conversational prompts, 1–3 taps each. We'll store the farm profile locally and at <code>/farm</code>.</p>
      <div id="farmBadge" class="farm-summary" style="margin-top:12px; display:none;"></div>
      <button id="btnStartDeviceSetup" type="button" class="ghost" style="display:none;margin-top:12px">Start here</button>
    </section>

    <!-- Grow Rooms Panel -->
    <section id="roomsPanel" class="card" style="border:1px solid #eee;border-radius:10px;padding:12px;margin-bottom:12px">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Grow Rooms
          <span class="hint" tabindex="0" data-tip="Set up rooms with layout, fixtures, schedule, sensors, and energy monitoring. Saved rooms appear below.">?</span>
        </h2>
        <div class="row" style="gap:6px">
          <button id="btnLaunchRoom" type="button" class="primary">New Grow Room</button>
        </div>
      </div>
      <p class="tiny" style="margin:8px 0 0;color:#475569">This wizard mirrors Farm Registration but is scoped to a single room.</p>
      <div id="roomsList" style="margin-top:12px"></div>
    </section>

    <section id="devicesPanel" class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin:0 0 8px">
        <h2 style="margin:0">
          Devices
          <span class="hint" tabindex="0" data-tip="Research-only telemetry. When Research Mode is on, view up to 10 devices or 5 groups with PPFD/DLI, energy (kWh 1/7/30), spectrum, and Now/ON/OFF controls. Plans and schedules are managed below.">?</span>
        </h2>
        <label class="row" style="align-items:center;gap:6px">
          <input id="devicesResearchToggle" type="checkbox" style="width:18px;height:18px" />
          <span class="tiny">Research Mode</span>
        </label>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:8px;align-items:center">
        <label class="row" style="gap:6px">
          <span class="tiny">Scope</span>
          <select id="deviceScope" style="min-width:160px">
            <option value="devices">Devices</option>
            <option value="groups">Groups</option>
          </select>
        </label>
        <label class="row" style="gap:6px;align-items:center">
          <span class="tiny">Select</span>
          <select id="deviceSelect" multiple size="4" style="min-width:260px"></select>
        </label>
        <span class="tiny" id="devicesNote" aria-live="polite"></span>
      </div>
      <p id="devicesEmpty" class="tiny" style="display:none;color:#64748b;margin:6px 0">No devices selected — enable Research Mode to view details. Plans and schedules are managed from the Groups section.</p>
      <div id="devices" class="grid cols-3"></div>
    </section>

    <!-- Plans (Grow recipes) Panel -->
    <section id="plansPanel" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Plans (Grow recipes)
          <span class="hint" tabindex="0" data-tip="Create and manage grow recipes. Each plan defines a spectrum mix and a target DLI. Preview spectrum, see where used, and assign later to Groups. DLI = PPFD × 3600 × photoperiod ÷ 1e6.">?</span>
        </h2>
        <span id="plansStatus" class="tiny" aria-live="polite"></span>
      </div>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0">
        <button id="btnAddPlan" type="button" class="ghost">Add Plan</button>
        <button id="btnSavePlans" type="button" class="primary">Save Plans</button>
        <button id="btnDownloadPlans" type="button" class="ghost">Download</button>
        <button id="btnUploadPlans" type="button" class="ghost">Upload</button>
        <input id="plansUpload" type="file" accept="application/json" style="display:none" />
      </div>
      <div id="plansList" class="grid cols-2" aria-live="polite"></div>
    </section>

  <!-- Schedules Panel moved above Groups per new order -->
  <section id="schedulesPanel" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Schedules
          <span class="hint" tabindex="0" data-tip="Define single or split light cycles (ON/OFF). We track wall-clock times in America/Toronto and sync to sched.json.">?</span>
        </h2>
        <span id="schedStatus" class="tiny" aria-live="polite"></span>
      </div>

      <div class="schedule-editor">
        <div class="schedule-editor__col">
          <div class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0">
            <input id="schedName" type="text" placeholder="Schedule name (e.g., Flower A)">
            <label class="row" style="gap:6px"><span>Timezone</span>
              <select id="schedTz">
                <option value="America/Toronto">America/Toronto</option>
              </select>
            </label>
          </div>

          <div class="schedule-mode" role="radiogroup" aria-label="Schedule mode">
            <span class="tiny">Mode</span>
            <label class="chip-option"><input type="radio" name="schedMode" value="one" checked><span>One cycle</span></label>
            <label class="chip-option"><input type="radio" name="schedMode" value="two"><span>Two cycles</span></label>
          </div>

          <div class="schedule-cycle" data-cycle="1">
            <div class="tiny">Cycle 1</div>
            <label><span>Start</span><input id="schedCycle1On" type="time" value="08:00"></label>
            <label><span>Photoperiod (h)</span><input id="schedC1Hours" type="number" min="0" max="24" step="0.5" value="12"></label>
            <div class="tiny" id="schedC1End">End: 20:00</div>
            <div class="tiny" style="color:#475569">Repeated daily</div>
          </div>
          <div class="schedule-cycle" data-cycle="2">
            <div class="tiny">Cycle 2</div>
            <label><span>Start</span><input id="schedCycle2On" type="time" value="00:00"></label>
            <label><span>Photoperiod (h)</span><input id="schedC2Hours" type="number" min="0" max="24" step="0.5" value="12"></label>
            <div class="tiny" id="schedC2End">End: 12:00</div>
            <div class="tiny" style="color:#475569">Repeated daily</div>
          </div>
        </div>

        <div class="schedule-editor__col schedule-editor__col--preview">
          <div class="schedule-math" aria-live="polite">
            <div><strong>ON total</strong><span id="schedOnTotal">--</span></div>
            <div><strong>OFF total</strong><span id="schedOffTotal">--</span></div>
            <div><strong>Δ vs 24h</strong><span id="schedDelta">--</span></div>
          </div>
          <div id="schedMathWarning" class="schedule-warning" role="alert" aria-live="polite" style="display:none"></div>
          <div class="schedule-preview schedule-preview--editor">
            <div class="schedule-preview__bar" id="schedEditorBar"></div>
            <div class="schedule-preview__legend">
              <span class="tiny">24h preview</span>
              <span class="schedule-preview__dst" id="schedEditorDst" style="display:none">DST</span>
            </div>
            <div class="schedule-preview__transitions" id="schedEditorTransitions"></div>
          </div>
        </div>
      </div>

      <!-- Group-only scope: removed Room/Zone selectors per redesign -->

      <div class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0">
        <button id="btnSaveSched" type="button" class="primary">Save Schedule</button>
        <button id="btnDeleteSched" type="button" class="ghost">Delete Schedule</button>
        <button id="btnReloadSched" type="button" class="ghost">Reload Schedules</button>
      </div>
    </section>

  <section id="groupsPanel" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Groups
          <span class="hint" tabindex="0" data-tip="Make named collections of devices. Quick selectors use Farm Rooms/Zones. Save writes to groups.json. Apply sends spectrum (HEX12) to all checked devices.">?</span>
        </h2>
        <span id="groupsStatus" class="tiny" aria-live="polite"></span>
      </div>

      <!-- Group pick / save -->
      <div class="row" style="gap:8px;flex-wrap:wrap;margin:8px 0">
        <label class="sr-only" for="groupSelect">Active group</label>
        <select id="groupSelect" title="Active group" style="min-width:180px"></select>
        <input id="groupName" type="text" placeholder="New or existing group name" style="min-width:220px">
        <button id="btnSaveGroup" type="button" class="primary">Save Group</button>
        <button id="btnDeleteGroup" type="button" class="ghost" title="Delete this group">Delete Group</button>
        <button id="btnReloadGroups" type="button" class="ghost">Reload Groups</button>
      </div>

      <!-- Group plan / schedule -->
      <div class="group-card-meta">
        <div class="row group-card-meta__row">
          <label class="row group-card-meta__field">
            <span class="tiny">Plan</span>
            <select id="groupPlan"></select>
          </label>
          <button id="btnGroupPlan" type="button" class="ghost">Edit Plan</button>
          <label class="row group-card-meta__field">
            <span class="tiny">Schedule</span>
            <select id="groupSchedule"></select>
          </label>
          <button id="btnGroupSchedule" type="button" class="ghost">Edit Schedule</button>
        </div>
        <div class="group-card-meta__chips">
          <span id="groupSpectraChip" class="group-spectra-chip" aria-live="polite">SpectraSync</span>
        </div>
        <span id="groupMetaStatus" class="tiny" aria-live="polite"></span>
      </div>
      <div id="groupSpectrumPreview" class="group-spectrum" aria-live="polite" style="margin:6px 0 8px"></div>
      <div id="groupSchedulePreview" class="schedule-preview schedule-preview--group" aria-live="polite"></div>
      
      <!-- Inline Group Schedule Editor (appears when editing a group's schedule) -->
      <div id="groupScheduleEditor" class="group-schedule-editor" style="display:none;margin-top:8px">
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap">
          <span class="tiny">Mode</span>
          <label class="chip-option"><input type="radio" name="groupSchedMode" value="one" checked><span>One cycle</span></label>
          <label class="chip-option"><input type="radio" name="groupSchedMode" value="two"><span>Two cycles</span></label>
          <button id="groupSchedSplit" class="ghost" type="button">Split 24 h evenly</button>
          <button id="groupSchedFix" class="ghost" type="button">Fix to 24 h</button>
          <span id="groupSchedWarn" class="tiny" style="color:#b45309;display:none"></span>
        </div>
        <div class="grid cols-2" style="align-items:end;gap:12px">
          <div>
            <div class="tiny">Cycle A</div>
            <label class="row" style="gap:6px"><span>Start</span><input id="gSchedC1Start" type="time" value="08:00"></label>
            <label class="row" style="gap:6px"><span>Photoperiod (h)</span><input id="gSchedC1Hours" type="number" min="0" max="24" step="0.5" value="12"></label>
            <div class="tiny" id="gSchedC1End">End: 20:00</div>
            <div class="tiny" style="color:#475569">Repeated daily</div>
          </div>
          <div id="gSchedC2" style="display:none">
            <div class="tiny">Cycle B</div>
            <label class="row" style="gap:6px"><span>Start</span><input id="gSchedC2Start" type="time" value="00:00"></label>
            <label class="row" style="gap:6px"><span>Photoperiod (h)</span><input id="gSchedC2Hours" type="number" min="0" max="24" step="0.5" value="12"></label>
            <div class="tiny" id="gSchedC2End">End: 12:00</div>
            <div class="tiny" style="color:#475569">Repeated daily</div>
          </div>
        </div>
        <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
          <div class="schedule-preview schedule-preview--editor" style="flex:1 1 280px">
            <div class="schedule-preview__bar" id="gSchedBar"></div>
            <div class="schedule-preview__legend"><span class="tiny">24h preview</span></div>
          </div>
          <div class="row" style="gap:12px">
            <button id="groupSchedSave" class="primary" type="button">Save</button>
            <button id="groupSchedDone" class="ghost" type="button">Done</button>
            <button id="groupSchedCancel" class="ghost" type="button">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Quick selectors -->
      <div id="groupQuick" class="row" style="gap:6px;flex-wrap:wrap;margin-bottom:8px"></div>

      <!-- Light checklist -->
      <div id="groupLightList" class="grid cols-3" style="margin-bottom:8px"></div>

      <!-- Ungrouped lights (available to add) -->
      <div class="group-roster-card" id="ungroupedLightsCard">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <h3 style="margin:0;font-size:15px;color:#0f172a">Ungrouped Lights</h3>
          <span id="ungroupedStatus" class="tiny" aria-live="polite"></span>
        </div>
        <div id="ungroupedList" class="grid cols-3" aria-live="polite"></div>
        <p id="ungroupedEmpty" class="tiny" style="display:none">All lights are assigned to groups.</p>
      </div>

      <!-- Group roster -->
      <div class="group-roster-card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <h3 style="margin:0;font-size:15px;color:#0f172a">Group Roster</h3>
          <span id="groupRosterStatus" class="tiny" aria-live="polite"></span>
        </div>
        <div class="group-roster-table" role="region" aria-live="polite">
          <table>
            <thead>
              <tr>
                <th scope="col">Light</th>
                <th scope="col">ID</th>
                <th scope="col">Location</th>
                <th scope="col">Rack</th>
                <th scope="col">Level</th>
                <th scope="col">Pos</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody id="groupRosterBody"></tbody>
          </table>
          <p id="groupRosterEmpty" class="tiny">Select lights to populate the roster.</p>
        </div>
      </div>

      <!-- Spectrum HUD -->
      <div class="grid cols-3" style="align-items:start; margin-top:8px">
        <div>
          <div class="kv"><span>Master</span><span class="row"><input id="gmaster"  type="range" min="0" max="100" value="60"><input id="gmasterv"  class="pct" type="number" min="0" max="100" value="60" style="width:70px">%</span></div>
          <div class="kv"><label class="row tiny" style="gap:6px"><input id="gratios" type="checkbox"><span>Lock ratios (Master scales)</span></label></div>
          <div class="kv"><span>CW</span><span class="row"><input id="gcw"  type="range" min="0" max="100" value="45"><input id="gcwv"  class="pct" type="number" min="0" max="100" value="45" style="width:70px">%</span></div>
          <div class="kv"><span>WW</span><span class="row"><input id="gww"  type="range" min="0" max="100" value="45"><input id="gwwv"  class="pct" type="number" min="0" max="100" value="45" style="width:70px">%</span></div>
          <div class="kv"><span>Blue</span><span class="row"><input id="gbl"  type="range" min="0" max="100" value="0"><input id="gblv"  class="pct" type="number" min="0" max="100" value="0" style="width:70px">%</span></div>
          <div class="kv"><span>Red</span><span class="row"><input id="grd"  type="range" min="0" max="100" value="0"><input id="grdv"  class="pct" type="number" min="0" max="100" value="0" style="width:70px">%</span></div>
        </div>

        <div>
          <h3 style="margin:0 0 6px">Group Actions</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <button id="grpOn"  type="button" class="ghost">Power ON</button>
            <button id="grpOff" type="button" class="ghost">Power OFF</button>
            <button id="grpApply" type="button" class="primary">Apply Spectrum</button>
          </div>
          <p id="groupLastHex" class="tiny" style="margin-top:6px;color:#475569"></p>
        </div>

        <!-- Twin spectrum preview beside sliders: HUD mix and Plan mix -->
        <div id="groupTwinSpectra" style="display:flex;flex-direction:column;gap:8px">
          <div class="device-spectrum">
            <div class="device-spectrum__title tiny">Current mix</div>
            <canvas id="groupHudCanvas" class="device-spectrum__canvas"></canvas>
          </div>
          <div class="device-spectrum">
            <div class="device-spectrum__title tiny">Plan spectrum</div>
            <canvas id="groupPlanCanvas" class="device-spectrum__canvas"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- IoT Devices Panel -->
    <section id="iotPanel" class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          IoT Devices
          <span class="hint" tabindex="0" data-tip="Manage all connected IoT devices including SwitchBot, Kasa, Shelly, and GreenReach devices. View status, set names and locations, and identify controlled equipment.">?</span>
        </h2>
        <div class="row" style="gap:6px">
          <button id="btnDiscover" type="button" class="primary" title="Mock device discovery">Discover new GreenReach Devices</button>
          <button id="btnOpenSwitchBotManager" type="button" class="ghost">Open Device Manager</button>
          <button id="btnRefreshSwitchBot" type="button" class="ghost">Refresh</button>
        </div>
      </div>
      <p class="tiny" style="margin:8px 0 0;color:#475569">Configure and monitor your IoT devices including SwitchBot environmental sensors, Kasa smart plugs, Shelly relays, and GreenReach grow lights. Use "Discover" to find new GreenReach devices or "Open Device Manager" for full management interface.</p>
      
      <div id="switchbotDevicesList" style="margin-top:12px">
        <!-- IoT devices will be loaded here -->
      </div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">
          Calibration
          <span class="hint" tabindex="0" data-tip="Match lights to a target using controller or meter readings. Gains apply at send-time as a correction layer.">?</span>
        </h2>
        <span id="calStatus" class="tiny" aria-live="polite"></span>
      </div>
      <p class="tiny" style="margin:8px 0 12px;color:#475569">Pick a scope (Light, Group, or Location), choose a target light, and preview corrections before applying. Calibrations store per-light gains that wrap all future writes.</p>
      <div class="row" style="gap:8px;flex-wrap:wrap;margin-bottom:12px">
        <button id="btnOpenCalWizard" type="button" class="primary">Open Calibration Wizard</button>
        <button id="btnReloadCal" type="button" class="ghost">Reload Profiles</button>
      </div>
      <div id="calibrationRegistry" class="cal-registry"></div>
    </section>
  </main>
  <div id="envModal" class="env-modal" aria-hidden="true">
    <div class="env-modal__backdrop" id="envModalBackdrop"></div>
    <div class="env-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="envModalTitle">
      <button type="button" class="env-modal__close" id="envModalClose" aria-label="Close">×</button>
      <div class="env-modal__content">
        <h2 id="envModalTitle" style="margin:0 0 12px">Trend</h2>
        <p class="tiny" id="envModalSubtitle" style="margin:0 0 12px;color:#475569"></p>
        <div id="envModalChart" class="env-modal__chart"></div>
        <div id="envModalStats" class="env-modal__stats"></div>
      </div>
    </div>
  </div>

  <div id="calModal" class="cal-modal" aria-hidden="true">
    <div class="cal-modal__backdrop" id="calModalBackdrop"></div>
    <div class="cal-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="calModalTitle">
      <button type="button" class="cal-modal__close" id="calModalClose" aria-label="Close">×</button>
      <form id="calWizardForm" novalidate>
        <p class="tiny" id="calModalProgress" aria-live="polite">Step 1 of 5</p>
        <h2 id="calModalTitle" style="margin:0 0 12px">Calibration Wizard</h2>
        <div id="calSteps">
          <section class="cal-step" data-step="scope-type">
            <p class="cal-question">What do you want to calibrate?</p>
            <div class="cal-options" role="radiogroup" aria-label="Calibration scope">
              <label class="chip-option"><input type="radio" name="calScopeType" value="lights" checked><span>Specific lights</span></label>
              <label class="chip-option"><input type="radio" name="calScopeType" value="group"><span>Group</span></label>
              <label class="chip-option"><input type="radio" name="calScopeType" value="location"><span>Location</span></label>
            </div>
            <p class="tiny" style="color:#64748b">Lights scope lets you hand-pick devices. Group uses the roster. Location uses Room / Zone assignments.</p>
          </section>

          <section class="cal-step" data-step="scope-detail">
            <p class="cal-question">Select the fixtures to calibrate.</p>
            <div id="calScopeLights" class="cal-scope-block" aria-live="polite"></div>
            <div id="calScopeGroup" class="cal-scope-block" style="display:none">
              <label class="row" style="gap:6px"><span>Group</span><select id="calScopeGroupSelect"></select></label>
              <p class="tiny" style="color:#475569">Lights inherit the current group roster. Offline lights are skipped automatically.</p>
            </div>
            <div id="calScopeLocation" class="cal-scope-block" style="display:none">
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <label class="row" style="gap:6px"><span>Room</span><select id="calScopeRoom"></select></label>
                <label class="row" style="gap:6px"><span>Zone</span><select id="calScopeZone"></select></label>
              </div>
              <p class="tiny" style="color:#475569">Lights with matching Room/Zone assignments will be included.</p>
            </div>
            <p id="calScopeSummary" class="tiny" style="margin-top:8px;color:#0f172a"></p>
          </section>

          <section class="cal-step" data-step="target">
            <p class="cal-question">Choose the target light baseline.</p>
            <select id="calTargetSelect" style="min-width:240px"></select>
            <label class="row" style="gap:6px;margin-top:8px"><input id="calTargetReconfirm" type="checkbox"><span>Include target in calibration (reconfirm baseline)</span></label>
            <p id="calTargetNote" class="tiny" style="color:#b91c1c"></p>
          </section>

          <section class="cal-step" data-step="sequence">
            <div class="cal-sequence" id="calSequenceStage">
              <div class="cal-sequence__header">
                <p class="cal-question" id="calSequenceTitle">Run the calibration patterns.</p>
                <span class="tiny" id="calSequenceMeta"></span>
              </div>
              <p class="tiny" id="calSequenceDescription" style="color:#475569"></p>
              <div class="cal-sequence__actions">
                <button id="calSequenceSend" type="button" class="ghost">Send pattern</button>
                <button id="calSequenceReset" type="button" class="ghost">Restore baseline</button>
              </div>
              <div class="cal-sequence__body">
                <div class="cal-sequence__target">
                  <h3 class="tiny" style="margin:0;color:#0f172a">Target reading</h3>
                  <div id="calSequenceTarget"></div>
                </div>
                <div class="cal-sequence__lights" id="calSequenceLights" aria-live="polite"></div>
              </div>
              <div class="cal-sequence__footer">
                <div id="calSequenceChecklist" class="cal-sequence__status" aria-live="polite"></div>
                <div class="row" style="gap:8px">
                  <button id="calSequencePrevTest" type="button" class="ghost">Previous pattern</button>
                  <button id="calSequenceNextTest" type="button" class="primary" disabled>Save & Next</button>
                </div>
              </div>
            </div>
          </section>

          <section class="cal-step" data-step="review">
            <p class="cal-question">Review the calibration preview.</p>
            <div id="calPreviewSummary" class="cal-preview-summary"></div>
            <div id="calPreviewTable" class="cal-preview-table" role="region" aria-live="polite"></div>
            <div id="calPreviewWarnings" class="cal-preview-warnings"></div>
          </section>
        </div>

        <div class="row cal-modal__footer" style="justify-content:space-between;margin-top:18px">
          <button id="calPrev" type="button" class="ghost">Back</button>
          <div class="row" style="gap:8px">
            <button id="calDryRun" type="button" class="ghost" style="display:none">Recalculate</button>
            <button id="calNext" type="button" class="primary">Next</button>
            <button id="calApply" type="submit" class="primary" style="display:none">Apply Calibration</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <div id="roomModal" class="room-modal" aria-hidden="true">
    <div class="room-modal__backdrop" id="roomModalBackdrop"></div>
    <div class="room-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="roomModalTitle">
      <button type="button" class="room-modal__close" id="roomModalClose" aria-label="Close">×</button>
      <form id="roomWizardForm" novalidate>
        <p class="tiny" id="roomModalProgress" aria-live="polite">Step 1 of 9</p>
        <h2 id="roomModalTitle" style="margin:0 0 12px">Set up a Grow Room</h2>
        <div class="room-setup-queue" id="roomSetupQueueWrap">
          <p class="tiny" style="margin-bottom:4px;color:#475569">Setup queue</p>
          <div id="roomSetupQueue" class="chip-row" role="list"></div>
          <p class="tiny" style="color:#64748b;margin-top:4px">Each chip is a todo. Tap one to jump to that part of the wizard so nothing is left half-configured.</p>
        </div>
        <div id="roomSteps">
          <section class="room-step" data-step="connectivity">
            <p class="room-question">First, let's make sure the local hub is online.</p>
            <div class="farm-step__stack">
              <div class="tiny">Hub presence</div>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <label class="tiny" style="display:flex;align-items:center;gap:6px"><input type="radio" name="roomHubPresence" value="yes"> Hub on-site</label>
                <label class="tiny" style="display:flex;align-items:center;gap:6px"><input type="radio" name="roomHubPresence" value="no"> No hub yet</label>
              </div>
              <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
                <input id="roomHubType" type="text" placeholder="Hub model (e.g., reTerminal, Jetson Nano)" style="flex:1;min-width:200px">
                <input id="roomHubIp" type="text" placeholder="Local IP address" style="flex:1;min-width:180px">
              </div>
              <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
                <button id="roomHubDetect" type="button" class="ghost">Detect hub</button>
                <button id="roomHubVerify" type="button" class="ghost">Verify Node-RED</button>
              </div>
              <p class="tiny" id="roomHubStatus" aria-live="polite" style="color:#0f172a;margin-top:4px"></p>
              <div class="tiny" style="color:#475569;margin-top:6px">We use the hub to push credentials to SwitchBot, Kasa, Shelly, and other devices. <a href="https://www.digi.com/blog/post/edge-computing-vs-cloud-computing" target="_blank" rel="noopener">Edge computing</a> keeps automations responsive even during cloud outages.</div>
              <div class="tiny" style="color:#64748b;margin-top:12px">Cloud tenant</div>
              <input id="roomCloudTenant" type="text" value="Azure" style="min-width:200px">
              <div class="tiny" style="color:#64748b;margin-top:12px">Assign farm management roles</div>
              <div class="role-grid">
                <label class="tiny">Admins
                  <input id="roomRoleAdmin" type="text" placeholder="Emails or names" style="min-width:220px">
                </label>
                <label class="tiny">Operators
                  <input id="roomRoleOperator" type="text" placeholder="Emails or names" style="min-width:220px">
                </label>
                <label class="tiny">Viewers
                  <input id="roomRoleViewer" type="text" placeholder="Emails or names" style="min-width:220px">
                </label>
              </div>
            </div>
          </section>

          <section class="room-step" data-step="devices">
            <p class="room-question">Next, onboard the smart plugs, switches, or sensors already in the room.</p>
            <div class="farm-step__stack">
              <div class="tiny" style="color:#475569">Pick a vendor, follow the vendor app instructions, then drop in the token or IP so we can control it.</div>
              <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px">
                <input id="roomDeviceName" type="text" placeholder="Device name (e.g., Dehu Plug)" style="min-width:180px">
                <select id="roomDeviceVendor" style="min-width:140px">
                  <option value="">Vendor</option>
                </select>
                <select id="roomDeviceModel" style="min-width:160px">
                  <option value="">Model</option>
                </select>
                <input id="roomDeviceHost" type="text" placeholder="Token or IP" style="min-width:160px">
                <button id="roomAddDeviceBtn" type="button" class="primary">Add device</button>
                <button id="roomDeviceScan" type="button" class="ghost">Scan network</button>
                <button id="roomDemoSwitchBot" type="button" class="ghost" style="background:#0ea5e9;color:white">Demo: Load Real SwitchBot Devices</button>
              </div>
              <div class="tiny" style="color:#475569;margin-top:8px">
                <strong>SwitchBot:</strong> App → Profile → Preferences → tap App Version 5–15× to unlock Developer Options, then copy the token + secret.<br>
                <strong>Kasa smart plugs:</strong> App → “+” → Smart Plug → follow Wi‑Fi onboarding, then note the device IP/name.<br>
                <strong>Shelly / Sonoff:</strong> Power on, connect to the hotspot, place it on the grow network, and grab the IP/API key.
              </div>
              <div class="tiny" style="color:#64748b;margin-top:6px">One device per screen keeps things calm. Use the queue above to revisit anything left incomplete.</div>
              <span id="roomDeviceInlineError" class="tiny" style="color:#EF4444;margin-top:6px" aria-live="polite"></span>
              <div id="roomDeviceSetupForms" style="margin-top:8px">
                <div id="deviceSetup-wifi" style="display:none;margin-top:8px">
                  <div class="tiny">Wi‑Fi setup</div>
                  <div class="row" style="gap:8px;margin-top:6px">
                    <input id="deviceWifiSsid" type="text" placeholder="SSID" style="min-width:160px">
                    <input id="deviceWifiPsk" type="password" placeholder="Wi‑Fi password (PSK)" style="min-width:160px">
                    <label class="tiny" style="align-items:center;display:flex;gap:6px"><input id="deviceWifiStatic" type="checkbox"> Use static IP</label>
                    <input id="deviceWifiStaticIp" type="text" placeholder="Static IP (optional)" style="min-width:140px;display:none">
                  </div>
                </div>
                <div id="deviceSetup-bluetooth" style="display:none;margin-top:8px">
                  <div class="tiny">Bluetooth pairing</div>
                  <div class="row" style="gap:8px;margin-top:6px">
                    <input id="deviceBtName" type="text" placeholder="Broadcast name" style="min-width:220px">
                    <input id="deviceBtPin" type="text" placeholder="Pairing code (if any)" style="min-width:120px">
                  </div>
                </div>
                <div id="deviceSetup-rs485" style="display:none;margin-top:8px">
                  <div class="tiny">RS‑485 / Modbus settings</div>
                  <div class="row" style="gap:8px;margin-top:6px">
                    <input id="deviceRs485Host" type="text" placeholder="Gateway IP / host" style="min-width:160px">
                    <input id="deviceRs485UnitId" type="number" placeholder="Modbus Unit ID" style="min-width:120px">
                    <select id="deviceRs485Baud" style="min-width:120px"><option>9600</option><option>19200</option><option>38400</option><option>115200</option></select>
                  </div>
                  <div id="err-deviceRs485UnitId" class="field-error" style="display:none"></div>
                </div>
                <div id="deviceSetup-0-10v" style="display:none;margin-top:8px">
                  <div class="tiny">0‑10V / Analog mapping</div>
                  <div class="row" style="gap:8px;margin-top:6px">
                    <input id="device0v10Channel" type="text" placeholder="Channel name / port" style="min-width:160px">
                    <input id="device0v10Scale" type="text" placeholder="Scale/calibration (e.g., 0-10V → 0-100%)" style="min-width:220px">
                  </div>
                  <div id="err-device0v10Channel" class="field-error" style="display:none"></div>
                  <div id="err-device0v10Scale" class="field-error" style="display:none"></div>
                </div>
              </div>
              <div class="tiny" id="deviceOnboardingStatus" style="color:#0f172a;margin-top:6px" aria-live="polite"></div>
              <ul id="roomDevicesList" class="farm-kb-selected" aria-live="polite" style="margin-top:8px"></ul>
            </div>
          </section>

          <section class="room-step" data-step="hardware">
            <p class="room-question">Which equipment do those devices operate?</p>
            <div class="farm-step__stack">
              <div class="tiny">Select all that apply</div>
              <div id="roomHardwareCats" class="chip-row" role="group" aria-label="Hardware categories">
                <button type="button" class="chip-option" data-value="grow-lights">Grow lights</button>
                <button type="button" class="chip-option" data-value="hvac">HVAC / climate</button>
                <button type="button" class="chip-option" data-value="dehumidifier">Dehumidifier</button>
                <button type="button" class="chip-option" data-value="fans">Fans</button>
                <button type="button" class="chip-option" data-value="vents">Vents</button>
                <button type="button" class="chip-option" data-value="irrigation">Irrigation / pumps</button>
                <button type="button" class="chip-option" data-value="controllers">Controllers / hubs</button>
                <button type="button" class="chip-option" data-value="other">Other</button>
              </div>
              <p class="tiny" style="color:#64748b;margin-top:6px">Start typing a model name to pull wattage, control methods, and metering hints from the recommended hardware library.</p>
              <input id="roomDeviceSearch" type="text" placeholder="Search gear (e.g., Gavita 1700e, SwitchBot Plug, Kasa Strip)" autocomplete="off">
              <ul id="roomDeviceSearchResults" class="farm-kb-results" aria-live="polite"></ul>
              <p class="tiny" style="color:#64748b">Picking a known model seeds the three-tap micro-form so you only confirm count, control, and energy.</p>
            </div>
          </section>

          <!-- Dynamic per-category setup host (used for HVAC, dehumidifier, fans, irrigation, controllers, other) -->
          <section class="room-step" data-step="category-setup">
            <p class="room-question" id="catSetupTitle">Category setup</p>
            <p class="tiny" id="catSetupIntro" style="color:#475569">We’ll capture a quick count, control method, and energy metering for each device type.</p>
            <p class="tiny" id="catSetupStatusLine" aria-live="polite" style="color:#0f172a"></p>
            <div class="farm-step__stack" id="catSetupBody"></div>
            <div class="row" id="catSetupActions" style="gap:8px;flex-wrap:wrap;margin-top:12px">
              <button type="button" class="ghost" id="catTestControl">Test control</button>
              <button type="button" class="primary" id="catSaveContinue">Mark complete &amp; next</button>
              <button type="button" class="ghost" id="catSaveDone">Mark follow-up</button>
              <button type="button" class="ghost" id="catSkip">Skip for now</button>
              <button type="button" class="ghost" id="catAddNew">Add device</button>
            </div>
            <p class="tiny" id="catSetupStatus" aria-live="polite" style="color:#0f172a"></p>
            <div class="row" id="catSetupNav" style="gap:8px;align-items:center;margin-top:8px;justify-content:space-between">
              <button type="button" class="ghost" id="catPrevType">Previous type</button>
              <span class="tiny" id="catSetupProgress" style="color:#475569"></span>
              <button type="button" class="ghost" id="catNextType">Next type</button>
            </div>
          </section>

          <section class="room-step" data-step="sensors">
            <p class="room-question">Which sensors will monitor this room?</p>
            <div class="farm-step__stack">
              <div class="tiny">Categories and placement</div>
              <div id="roomSensorCats" class="sensor-grid" role="group" aria-label="Room sensor categories">
                <div class="sensor-config" data-sensor="tempRh">
                  <label class="chip-option"><input type="checkbox" value="tempRh"><span>Temp/RH</span></label>
                  <select class="sensor-location" data-sensor="tempRh">
                    <option value="">Location…</option>
                    <option value="room">Room</option>
                    <option value="zone">Zone</option>
                    <option value="canopy">Canopy</option>
                    <option value="intake">Intake</option>
                    <option value="exhaust">Exhaust</option>
                    <option value="outdoors">Outdoors</option>
                  </select>
                  <p class="tiny" style="color:#475569">NTC thermistors give low-cost, high-sensitivity temperature data while capacitive humidity sensors stay accurate over time (<a href="https://blog.amphenol-sensors.com/industrial-blog/temperature-and-humidity-sensors-in-agriculture" target="_blank" rel="noopener">Amphenol Sensors</a>).</p>
                </div>
                <div class="sensor-config" data-sensor="co2">
                  <label class="chip-option"><input type="checkbox" value="co2"><span>CO₂</span></label>
                  <select class="sensor-location" data-sensor="co2">
                    <option value="">Location…</option>
                    <option value="room">Room</option>
                    <option value="zone">Zone</option>
                    <option value="canopy">Canopy</option>
                    <option value="intake">Intake</option>
                    <option value="exhaust">Exhaust</option>
                    <option value="outdoors">Outdoors</option>
                  </select>
                  <p class="tiny" style="color:#475569">NDIR CO₂ sensors deliver reliable readings with strong stability and quick response for enrichment control (<a href="https://solution.seeedstudio.com/product/sensecap-solo-co2-5000-ndir-co2-sensor-supporting-modbus-rtu-rs485-and-sdi-12/" target="_blank" rel="noopener">Seeed Studio</a>).</p>
                </div>
                <div class="sensor-config" data-sensor="vpd">
                  <label class="chip-option"><input type="checkbox" value="vpd"><span>Dewpoint/VPD</span></label>
                  <select class="sensor-location" data-sensor="vpd">
                    <option value="">Location…</option>
                    <option value="room">Room</option>
                    <option value="zone">Zone</option>
                    <option value="canopy">Canopy</option>
                    <option value="intake">Intake</option>
                    <option value="exhaust">Exhaust</option>
                    <option value="outdoors">Outdoors</option>
                  </select>
                  <p class="tiny" style="color:#475569">Pair dewpoint/VPD monitoring with canopy or intake placement to keep plants within their comfort band.</p>
                </div>
                <div class="sensor-config" data-sensor="ppfd">
                  <label class="chip-option"><input type="checkbox" value="ppfd"><span>Light/PPFD</span></label>
                  <select class="sensor-location" data-sensor="ppfd">
                    <option value="">Location…</option>
                    <option value="room">Room</option>
                    <option value="zone">Zone</option>
                    <option value="canopy">Canopy</option>
                    <option value="intake">Intake</option>
                    <option value="exhaust">Exhaust</option>
                    <option value="outdoors">Outdoors</option>
                  </select>
                  <p class="tiny" style="color:#475569">Use canopy-mounted quantum sensors to validate PPFD and calculate DLI for each zone.</p>
                </div>
                <div class="sensor-config" data-sensor="energy">
                  <label class="chip-option"><input type="checkbox" value="energy"><span>Energy/Power</span></label>
                  <select class="sensor-location" data-sensor="energy">
                    <option value="">Location…</option>
                    <option value="room">Room</option>
                    <option value="zone">Zone</option>
                    <option value="canopy">Canopy</option>
                    <option value="intake">Intake</option>
                    <option value="exhaust">Exhaust</option>
                    <option value="outdoors">Outdoors</option>
                  </select>
                  <p class="tiny" style="color:#475569">Tie branch CTs or smart plugs to the same zones as your loads for clean energy per-cycle insights.</p>
                </div>
              </div>
              <p class="tiny" style="color:#64748b">We pre-select sensors based on fixtures and control methods; adjust placements to match your canopy map.</p>
            </div>
          </section>

          <section class="room-step" data-step="room-name">
            <p class="room-question">Now that hardware is mapped, what should we call this grow room?</p>
            <input id="roomName" type="text" placeholder="e.g., Flower A" required>
            <p class="tiny" style="color:#64748b;margin-top:6px">Friendly names from Farm Registration appear here so everyone speaks the same language.</p>
          </section>

          <section class="room-step" data-step="location">
            <p class="room-question">Which farm location does it belong to?</p>
            <div class="farm-step__stack">
              <label class="tiny">Location</label>
              <select id="roomLocationSelect" style="min-width:220px"></select>
              <p class="tiny" style="color:#64748b">Locations are pulled from your Farm registration.</p>
            </div>
          </section>

          <section class="room-step" data-step="layout">
            <p class="room-question">How's the canopy laid out?</p>
            <div class="farm-step__stack">
              <div class="chip-row" id="roomLayoutType" role="group" aria-label="Layout type">
                <button type="button" class="chip-option" data-value="benches">Benches</button>
                <button type="button" class="chip-option" data-value="racks">Racks (vertical)</button>
                <button type="button" class="chip-option" data-value="open">Open floor</button>
              </div>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <label class="tiny">Rows <input id="roomRows" type="number" min="0" value="0" style="width:90px"></label>
                <label class="tiny">Racks/row <input id="roomRacks" type="number" min="0" value="0" style="width:110px"></label>
                <label class="tiny">Levels/rack <input id="roomLevels" type="number" min="0" value="0" style="width:120px"></label>
              </div>
            </div>
          </section>

          <section class="room-step" data-step="zones">
            <p class="room-question">Any zones or canopy levels we should track?</p>
            <div class="farm-step__stack">
              <p class="tiny" style="color:#64748b">Name the zones, tiers or aisles you reference day to day. We'll reuse them for dashboards and sensor placement.</p>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <input id="roomZoneInput" type="text" placeholder="e.g., South Canopy" style="flex:1;min-width:200px">
                <button type="button" class="ghost" id="roomZoneAdd">Add zone</button>
              </div>
              <ul id="roomZoneList" class="farm-kb-selected" aria-live="polite" style="margin-top:8px"></ul>
            </div>
          </section>

          <section class="room-step" data-step="fixtures">
            <p class="room-question">Add the grow lights used here.</p>
            <div class="farm-step__stack">
              <div class="row" style="gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:6px">
                <label class="tiny">How many lights operate in series?
                  <input id="roomSeriesCount" type="number" min="0" value="0" style="width:120px;margin-left:6px">
                </label>
                <label class="tiny">Target PPFD at canopy
                  <input id="roomTargetPpfd" type="number" min="0" value="0" style="width:120px;margin-left:6px">
                </label>
                <label class="tiny">Photoperiod (hrs/day)
                  <input id="roomPhotoperiod" type="number" min="0" max="24" value="18" style="width:120px;margin-left:6px">
                </label>
              </div>
              <input id="roomKbSearch" type="text" placeholder="Search models (e.g., Gavita 1700e)" autocomplete="off">
              <div style="margin-top:6px">
                <button id="roomKbUploadBtn" type="button" class="ghost">Upload nameplate / datasheet</button>
                <input id="roomKbUpload" type="file" accept="image/*,application/pdf" style="display:none">
              </div>
              <div class="tiny" style="color:#64748b">Results</div>
              <ul id="roomKbResults" class="farm-kb-results" aria-live="polite"></ul>
              <div class="tiny" style="color:#64748b">Selected</div>
              <ul id="roomKbSelected" class="farm-kb-selected" aria-live="polite"></ul>
              <p class="tiny" style="color:#64748b;margin-top:6px">We use target PPFD and photoperiod to calculate Daily Light Integral (DLI = PPFD × (3600 × hours) ÷ 1,000,000) for downstream analytics.</p>
            </div>
          </section>

          <section class="room-step" data-step="control">
            <p class="room-question">How will the fixtures be controlled?</p>
            <div class="farm-step__stack">
              <div class="tiny">Control method</div>
              <div id="roomControlMethod" class="chip-row" role="group" aria-label="Control method">
                <button type="button" class="chip-option" data-value="wifi">Wi‑Fi / App</button>
                <button type="button" class="chip-option" data-value="smart-plug">Smart plug</button>
                <button type="button" class="chip-option" data-value="0-10v">0‑10V / Wired</button>
                <button type="button" class="chip-option" data-value="rs485">RS‑485 / Modbus</button>
                <button type="button" class="chip-option" data-value="other">Other</button>
              </div>
              <div id="roomControlDetails" style="margin-top:8px" class="tiny" aria-live="polite"></div>
            </div>
          </section>

          <section class="room-step" data-step="energy">
            <p class="room-question">How will you monitor energy?</p>
            <div class="farm-step__stack">
              <div class="chip-row" id="roomEnergy" role="group" aria-label="Energy monitoring">
                <button type="button" class="chip-option" data-value="ct-branch">CT/branch meters</button>
                <button type="button" class="chip-option" data-value="smart-plugs">Smart plugs</button>
                <button type="button" class="chip-option" data-value="built-in">Built-in meter</button>
                <button type="button" class="chip-option" data-value="none">None</button>
              </div>
              <label class="tiny" style="margin-top:8px">Daily runtime (hrs)
                <input id="roomEnergyHours" type="number" min="0" max="24" value="18" style="width:120px;margin-left:6px">
              </label>
              <p class="tiny" style="color:#64748b">Energy consumption is estimated as wattage ÷ 1000 × runtime hours (<a href="https://bkvenergy.com/blog/how-to-calculate-kwh/" target="_blank" rel="noopener">BKV Energy</a>). Adjust runtime to line up with your lighting schedule.</p>
            </div>
          </section>

          <section class="room-step" data-step="grouping">
            <p class="room-question">Group devices and assign plans so automations can start smart.</p>
            <div class="farm-step__stack">
              <div class="tiny">Groups</div>
              <div class="row" style="gap:8px;flex-wrap:wrap">
                <input id="roomGroupNameInput" type="text" placeholder="Add group (e.g., Flower Tier A)" style="flex:1;min-width:220px">
                <button id="roomGroupAdd" type="button" class="ghost">Add group</button>
              </div>
              <div class="tiny" style="color:#64748b;margin-top:6px">Suggested groups from your zones appear as you add them. Each group can share plans and schedules.</div>
              <div id="roomGroupSuggestions" class="chip-row" role="list" aria-label="Suggested groups"></div>
              <ul id="roomGroupList" class="farm-kb-selected" aria-live="polite" style="margin-top:8px"></ul>
              <label class="tiny" style="margin-top:12px">Assign grow plan
                <select id="roomGroupPlan" style="min-width:220px"></select>
              </label>
              <label class="tiny" style="margin-top:12px">Schedule
                <select id="roomGroupSchedule" style="min-width:220px"></select>
              </label>
              <label class="chip-option" style="margin-top:12px"><input type="checkbox" id="roomGroupSpectraSync" checked><span>Enable SpectraSync (dynamic spectrum &amp; PPFD)</span></label>
              <p class="tiny" style="color:#64748b;margin-top:6px">DLI = PPFD × (3600 × photoperiod) ÷ 1,000,000 (<a href="https://support.monnit.com/article/81-what-is-the-daily-light-integral-in-crop-monitoring/" target="_blank" rel="noopener">Monnit</a>). We store these details for time-series analysis, AI recipes, and energy forecasting.</p>
            </div>
          </section>

          <section class="room-step" data-step="review">
            <p class="room-question">Review this room before saving.</p>
            <div id="roomReview" class="farm-review"></div>
          </section>

        </div>

        <div class="row room-modal__footer" style="justify-content:space-between;margin-top:18px">
          <button id="roomPrev" type="button" class="ghost">Back</button>
          <div class="row" style="gap:8px">
            <button id="roomNext" type="button" class="primary">Next</button>
            <button id="btnSaveRoom" type="submit" class="primary" style="display:none">Save Room</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- Device Pairing Modal (guided Wi‑Fi / Bluetooth setup) -->
  <div id="devicePairModal" class="device-pair-modal" aria-hidden="true">
    <div class="device-pair-modal__backdrop" id="devicePairBackdrop"></div>
    <div class="device-pair-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="devicePairTitle">
      <button type="button" class="device-pair-modal__close" id="devicePairClose" aria-label="Close">×</button>
      <form id="devicePairForm" novalidate>
        <p class="tiny" id="devicePairProgress" aria-live="polite">Step 1 of 3</p>
        <h2 id="devicePairTitle" style="margin:0 0 12px">Pair device</h2>
        <div id="devicePairSteps">
          <section class="pair-step" data-step="transport">
            <p class="pair-question">Which transport should we use to pair?</p>
            <div class="chip-row" id="pairTransport" role="radiogroup" aria-label="Transport">
              <label class="chip-option"><input type="radio" name="pairTransport" value="wifi" checked><span>Wi‑Fi</span></label>
              <label class="chip-option"><input type="radio" name="pairTransport" value="bluetooth"><span>Bluetooth</span></label>
            </div>
            <p class="tiny" style="color:#64748b">Select the transport that the device supports. The KB will suggest one.</p>
          </section>

          <section class="pair-step" data-step="wifi">
            <p class="pair-question">Wi‑Fi details</p>
            <div class="farm-step__stack">
              <input id="pairWifiSsid" type="text" placeholder="SSID" style="min-width:220px">
              <input id="pairWifiPsk" type="password" placeholder="Wi‑Fi password (PSK)" style="min-width:220px">
              <label class="tiny" style="align-items:center;display:flex;gap:6px"><input id="pairWifiStatic" type="checkbox"> Use static IP</label>
              <input id="pairWifiStaticIp" type="text" placeholder="Static IP (optional)" style="min-width:160px;display:none">
              <div class="tiny" style="color:#64748b;margin-top:8px">If the device uses AP-mode for initial setup, follow vendor instructions to connect to its temporary SSID and then return here to enter credentials.</div>
            </div>
          </section>

          <section class="pair-step" data-step="bluetooth">
            <p class="pair-question">Bluetooth pairing</p>
            <div class="farm-step__stack">
              <input id="pairBtName" type="text" placeholder="Advertised device name (optional)" style="min-width:260px">
              <input id="pairBtPin" type="text" placeholder="Pairing code (if any)" style="min-width:160px">
              <div class="tiny" style="color:#64748b;margin-top:8px">Most BLE sensors don't require a PIN. Use the advertised name to help find the device in scans or enter a known MAC/address here.</div>
            </div>
          </section>

          <section class="pair-step" data-step="review">
            <p class="pair-question">Review pairing info</p>
            <div id="pairReview" class="farm-review tiny" style="color:#0f172a"></div>
          </section>
        </div>

        <div class="row device-pair-modal__footer" style="justify-content:space-between;margin-top:18px">
          <button id="pairPrev" type="button" class="ghost">Back</button>
          <div class="row" style="gap:8px">
            <button id="pairNext" type="button" class="primary">Next</button>
            <button id="pairSave" type="submit" class="primary" style="display:none">Save & Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div id="farmModal" class="farm-modal" aria-hidden="true">
    <div class="farm-modal__backdrop" id="farmModalBackdrop"></div>
    <div class="farm-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="farmModalTitle">
      <button type="button" class="farm-modal__close" id="farmModalClose" aria-label="Close">×</button>
      <form id="farmWizardForm" novalidate>
        <p class="tiny" id="farmModalProgress" aria-live="polite">Step 1 of 6</p>
        <h2 id="farmModalTitle" style="margin:0 0 12px">Let’s get you online</h2>
        <div id="farmSteps">
          <section class="farm-step" data-step="connection-choice">
            <p class="farm-question">Let’s get you online—are you connecting this reTerminal to Wi‑Fi or Ethernet today?</p>
            <div class="chip-row" id="farmConnectionChoice" role="radiogroup" aria-label="Connection type">
              <button type="button" class="chip-option" data-value="wifi">Wi‑Fi</button>
              <button type="button" class="chip-option" data-value="ethernet">Ethernet</button>
            </div>
            <p class="tiny" style="margin-top:8px;color:#475569">Switch anytime—Wi‑Fi walks you through SSID, password, and a connection test.</p>
          </section>

          <section class="farm-step" data-step="wifi-select">
            <p class="farm-question">Great—let’s pick the Wi‑Fi network.</p>
            <div class="farm-step__stack">
              <div class="row" style="gap:6px;align-items:center;flex-wrap:wrap">
                <button id="btnScanWifi" type="button" class="ghost">Scan again</button>
                <span id="wifiScanStatus" class="tiny" aria-live="polite"></span>
                <button id="btnManualSsid" type="button" class="ghost">Add hidden network</button>
              </div>
              <div id="wifiNetworkList" class="chip-grid" role="listbox" aria-label="Available Wi‑Fi networks"></div>
            </div>
          </section>

          <section class="farm-step" data-step="wifi-password">
            <p class="farm-question">Enter the password for <span id="wifiChosenSsid" class="inline-chip"></span>.</p>
            <div class="farm-step__stack">
              <input id="wifiPassword" type="password" autocomplete="new-password" placeholder="Wi‑Fi password" required>
              <label class="tiny" style="display:flex;align-items:center;gap:6px"><input id="wifiShowPassword" type="checkbox">Show password</label>
              <label class="tiny" style="display:flex;align-items:center;gap:6px">
                <input id="wifiReuseDevices" type="checkbox" checked>
                Use this network for device discovery
              </label>
            </div>
          </section>

          <section class="farm-step" data-step="wifi-test">
            <p class="farm-question">Testing that connection…</p>
            <div class="farm-step__stack">
              <button id="btnTestWifi" type="button" class="primary">Test connection</button>
              <div id="wifiTestStatus" class="farm-review" aria-live="polite"></div>
            </div>
          </section>

          <section class="farm-step" data-step="location">
            <p class="farm-question">Where is this farm?</p>
            <div class="farm-step__stack">
              <input id="farmName" name="farmName" type="text" autocomplete="organization" placeholder="Farm name" required>
              <input id="farmAddress" type="text" autocomplete="street-address" placeholder="Street address">
              <div class="row" style="gap:6px;flex-wrap:wrap">
                <input id="farmCity" type="text" autocomplete="address-level2" placeholder="City">
                <input id="farmState" type="text" autocomplete="address-level1" placeholder="State / Province" style="max-width:140px">
                <input id="farmPostal" type="text" autocomplete="postal-code" placeholder="Postal code" style="max-width:140px">
              </div>
              <div style="display: flex; gap: 6px; align-items: center; margin-top: 8px; flex-wrap: wrap;">
                <button type="button" id="btnFindLocation" class="btn-secondary" style="font-size: 14px;">📍 Find Location</button>
                <button type="button" id="btnUseMyLocation" class="btn-secondary" style="font-size: 14px;">🧭 Use my location</button>
                <span id="locationStatus" class="tiny" style="color: #666;"></span>
              </div>
              <div id="locationResults" class="location-results" style="display: none; margin-top: 8px;">
                <div class="tiny" style="margin-bottom: 4px; color: #666;">Select your farm location:</div>
                <div id="locationOptions"></div>
              </div>
              <div id="weatherDisplay" class="weather-display" style="display: none; margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                <div class="weather-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 18px;">🌤️</span>
                  <strong style="color: #333;">Current Weather</strong>
                </div>
                <div id="weatherContent"></div>
              </div>
              <label class="tiny" style="display:flex;align-items:center;gap:6px">
                Timezone
                <select id="farmTimezone" style="min-width:200px"></select>
              </label>
            </div>
          </section>

          <section class="farm-step" data-step="contact">
            <p class="farm-question">Who should we contact about this farm?</p>
            <div class="farm-step__stack">
              <input id="contactName" name="contactName" type="text" autocomplete="name" placeholder="Contact name" required>
              <input id="contactEmail" name="contactEmail" type="email" autocomplete="email" placeholder="Email address" required>
              <input id="contactPhone" name="contactPhone" type="tel" autocomplete="tel" placeholder="Phone number">
              <input id="contactWebsite" name="contactWebsite" type="url" autocomplete="url" placeholder="Website (for branding)">
            </div>
          </section>

          <section class="farm-step" data-step="spaces">
            <p class="farm-question">Add your spaces—rooms first, then zones within each room.</p>
            <div class="farm-step__stack">
              <div class="row" style="gap:6px;flex-wrap:wrap">
                <input id="newRoomName" type="text" placeholder="Room name (e.g., Flower A)">
                <button id="btnAddRoom" type="button" class="ghost">Add room</button>
              </div>
              <div id="roomsEditor" class="farm-spaces" aria-live="polite"></div>
            </div>
          </section>

          <section class="farm-step" data-step="review">
            <p class="farm-question">Farm · Rooms · Zones — ready to save?</p>
            <div class="farm-review" id="farmReview"></div>
          </section>
        </div>

        <div class="row" style="justify-content:space-between;margin-top:18px">
          <button id="farmPrev" type="button" class="ghost">Back</button>
          <div class="row" style="gap:8px">
            <button id="farmNext" type="button" class="primary">Next</button>
            <button id="btnSaveFarm" type="submit" class="primary" style="display:none">Save Farm</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="deviceManager" class="device-manager" aria-hidden="true">
    <div class="device-manager__backdrop" id="deviceManagerBackdrop"></div>
    <div class="device-manager__window" role="dialog" aria-modal="true" aria-labelledby="deviceManagerTitle">
      <header class="device-manager__header">
        <div>
          <h2 id="deviceManagerTitle">Device Manager</h2>
          <p class="tiny" id="deviceManagerSubtitle">Scan Wi‑Fi, BLE, and MQTT sources to bring devices into the farm.</p>
        </div>
        <button type="button" id="deviceManagerClose" class="ghost" aria-label="Close">×</button>
      </header>
      <div class="device-manager__toolbar">
        <button id="btnRunDiscovery" type="button" class="primary">Run discovery</button>
        <span id="discoveryStatus" class="tiny" aria-live="polite"></span>
        <div class="chip-row" role="tablist" aria-label="Discovery filters">
          <button type="button" class="chip-option" data-filter="all" aria-selected="true">All</button>
          <button type="button" class="chip-option" data-filter="added">Added</button>
          <button type="button" class="chip-option" data-filter="ignored">Ignored</button>
        </div>
      </div>
      <div id="deviceDiscoveryResults" class="device-manager__results" aria-live="polite"></div>
      <footer class="device-manager__footer">
        <div id="deviceManagerSummary" class="tiny"></div>
        <button id="btnOpenAutomation" type="button" class="ghost">Open Automation Card</button>
      </footer>
    </div>
  </div>

  <footer id="planSummary" class="tiny" style="padding:12px;color:#475569"></footer>
  <div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
