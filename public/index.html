<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Light Engine Charlie</title>
  <link href="styles.charlie.css" rel="stylesheet">
  <script src="app.charlie.js"></script>
</head>
<body class="gr-shell">
  <template id="aiAutomationClusterTemplate">
    <div class="ai-automation-cluster gr-status-badges" role="group" aria-label="AI, Automation, and SpectraSync controls">
      <div class="chip" data-control="ai">
        <span data-icon-slot="ai" data-icon-label="AI" data-icon-control="ai"></span>
        <span class="chip__status" data-status></span>
      </div>
      <div class="chip" data-control="automation">
        <span data-icon-slot="auto" data-icon-label="Automation" data-icon-control="automation"></span>
        <span class="chip__status" data-status></span>
      </div>
      <div class="chip" data-control="spectra">
        <span data-icon-slot="spectra" data-icon-label="SpectraSync" data-icon-control="spectra"></span>
        <span class="chip__status" data-status></span>
      </div>
      <span class="chip chip--tour-lock" data-role="tour-lock" hidden>Tour Lock</span>
    </div>
  </template>
  <aside id="sidebar" class="dashboard-sidebar sidebar" aria-label="Setup and management navigation">
  <div class="sidebar-header">
    <h2 class="sidebar-title">Setup &amp; Management</h2>
    <p class="tiny text-muted">Organize farm setup, device control, and daily grow operations.</p>
  </div>
  <nav class="sidebar-nav" data-role="sidebar-nav">
    <button class="sidebar-link sidebar-link--overview is-active" type="button" data-sidebar-link data-target="overview" aria-current="page">
      <span>Grow Room Overview</span>
    </button>

    <div class="sidebar-group" data-group="farm-setup">
      <button class="sidebar-group__trigger" type="button" aria-expanded="false">
        <span>Farm Setup</span>
        <span class="sidebar-group__icon" aria-hidden="true"></span>
      </button>
      <div class="sidebar-group__items" role="menu" hidden>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="farm-setup" data-target="farm-registration">
          Farm Registration
        </button>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="farm-setup" data-target="grow-rooms">
          Grow Rooms
        </button>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="farm-setup" data-target="light-setup">
          Light Setup
        </button>
      </div>
    </div>

    <div class="sidebar-group" data-group="control-devices">
      <button class="sidebar-group__trigger" type="button" aria-expanded="false">
        <span>Control Devices</span>
        <span class="sidebar-group__icon" aria-hidden="true"></span>
      </button>
      <div class="sidebar-group__items" role="menu" hidden>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="control-devices" data-target="smart-controllers">
          Smart Controllers
        </button>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="control-devices" data-target="control-assignments">
          Control Assignments
        </button>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="control-devices" data-target="automation">
          Automation
        </button>
      </div>
    </div>

    <div class="sidebar-group" data-group="grow-management">
      <button class="sidebar-group__trigger" type="button" aria-expanded="false">
        <span>Grow Management</span>
        <span class="sidebar-group__icon" aria-hidden="true"></span>
      </button>
      <div class="sidebar-group__items" role="menu" hidden>
        <button type="button" class="sidebar-link" data-sidebar-link data-group="grow-management" data-target="plans">
          Plans (Grow Recipes)
        </button>
      </div>
    </div>
  </nav>

  <div class="sidebar-standalone">
    <button type="button" class="sidebar-link" data-sidebar-link data-target="calibration">
      Calibration
    </button>
    <button type="button" class="sidebar-link" data-sidebar-link data-target="profile">
      Profile
    </button>
    <button type="button" class="sidebar-link" data-sidebar-link data-target="groups-v2">
      Groups V2
    </button>
  </div>
</aside>

  <main class="main">
  <header id="mainHeader" class="dashboard-header">
    <section id="topCard" class="card card--hero top-card gr-card">
      <div class="row row--between row--center top-card__content">
        <!-- Left side: Farm branding -->
        <div class="row row--center row--gap-md flex-1">
          <img id="farmLogo" src="" alt="Farm logo" class="farm-logo" onerror="this.style.display='none'">
          <div id="farmBrandingSection" class="farm-branding">
            <h1 id="farmName" class="farm-name"></h1>
            <div id="farmTagline" class="tiny farm-tagline"></div>
          </div>
        </div>
        <!-- Right side: Light Engine Charlie and controls -->
        <div class="row row--gap-lg row--center top-card__status">
          <div class="text-right">
            <h1 id="lightEngineTitle" class="top-card__title">Light Engine Charlie</h1>
            <div class="automation-indicator" id="automationIndicator" aria-live="polite">
              <span class="automation-indicator__dot" aria-hidden="true"></span>
              <span class="automation-indicator__label">Centralized Automation</span>
              <span class="automation-indicator__status" id="automationIndicatorStatus">Idle</span>
            </div>
            <div id="communicationStatus" class="tiny text-muted top-card__status-text">System Online</div>
          </div>
          <button id="btn-ia-assist" aria-label="AI Assist" class="ia-assist" title="AI Assist" type="button"></button>
        </div>
      </div>
    </section>
  </header>

      <div class="dashboard-content">
      <div id="dashboard" class="dashboard-main cards">
      <section id="dehumidifierSetupCard" class="card gr-card" data-role="dehumidifier-setup">
        <h2 class="section-title">Dehumidifier Setup</h2>
        <div class="equip-row" data-equip="dehum" data-room="room1">
          <button type="button" data-op="dec" data-target="dehum:room1">–</button>
          <input data-input="dehum:room1" value="0" inputmode="numeric" aria-label="Room 1 dehumidifier count" />
          <button type="button" data-op="inc" data-target="dehum:room1">+</button>
        </div>
      </section>
      <section id="environmentalAiCard" class="card card--feature hud-shell gr-card gr-full">
              <div class="row row--between row--center mb-md hud-shell__header">
                <h2 class="section-title hud-shell__title">Environmental & AI Features</h2>
                <span class="tiny text-muted">Autonomous Growing Intelligence</span>
              </div>

              <div class="ai-features-horizontal">
            <!-- SpectraSync Feature -->
            <div class="ai-feature-card active" id="spectraSyncFeature" data-feature="spectrasync">
              <div class="ai-feature-icon spectrasync-icon">
                <span data-icon-slot="spectra" data-icon-label="SpectraSync" data-icon-static="true"></span>
              </div>
              <div class="ai-feature-content">
                <h3>SpectraSync®</h3>
                <div class="ai-feature-status on">ON</div>
                <div class="ai-feature-description">Real-time spectrum optimization synchronized with plant growth cycles</div>
              </div>
            </div>

            <!-- E.V.I.E Feature -->
            <div class="ai-feature-card" id="evieFeature" data-feature="evie">
              <div class="ai-feature-icon evie-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M8 12L10 14L12 10L14 14L16 12" fill="currentColor" opacity="0.3"/>
                  <circle cx="12" cy="12" r="3" fill="currentColor" opacity="0.6"/>
                </svg>
              </div>
              <div class="ai-feature-content">
                <h3>E.V.I.E</h3>
                <div class="ai-feature-status off">OFF</div>
                <div class="ai-feature-description">Environmental Virtual Intelligence Engine for autonomous climate control</div>
              </div>
            </div>

            <!-- IA In Training Feature -->
            <div class="ai-feature-card active" id="iaTrainingFeature" data-feature="ia-training">
              <div class="ai-feature-icon ia-training-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <polygon points="12,2 22,20 2,20" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <path d="M12 8L12 14" stroke="currentColor" stroke-width="1.5"/>
                  <circle cx="12" cy="16" r="1" fill="currentColor"/>
                  <circle cx="8" cy="18" r="1" fill="currentColor" opacity="0.3"/>
                  <circle cx="16" cy="18" r="1" fill="currentColor" opacity="0.3"/>
                </svg>
              </div>
              <div class="ai-feature-content">
                <h3>IA In Training</h3>
                <div class="ai-feature-status always-on">ALWAYS ON</div>
                <div class="ai-feature-description">Intelligent Agent continuously learning from farm operations and outcomes</div>
              </div>
            </div>

            <!-- IA Assist Feature -->
            <div class="ai-feature-card active" id="iaAssistFeature" data-feature="ia-assist">
              <div class="ai-feature-icon ia-assist-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2L15 9L22 9L17 14L19 22L12 18L5 22L7 14L2 9L9 9L12 2Z" stroke="currentColor" stroke-width="1.5" fill="none"/>
                  <path d="M12 8L12 14" stroke="currentColor" stroke-width="1.5"/>
                </svg>
              </div>
              <div class="ai-feature-content">
                <h3>IA Assist</h3>
                <div class="ai-feature-status always-on">ALWAYS ON</div>
                <div class="ai-feature-description">AI-powered recommendations and automated decision support system</div>
              </div>
            </div>

            <!-- Environmental Impact Index Feature -->
            <div class="ai-feature-card" id="eiiFeature" data-feature="eii">
              <div class="ai-feature-icon eii-icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5"/>
                  <path d="M8 12L10 10L12 14L16 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="12" r="1" fill="currentColor"/>
                </svg>
              </div>
              <div class="ai-feature-content">
                <h3>E.I²</h3>
                <div class="ai-feature-status dev">DEV</div>
                <div class="ai-feature-description">Environmental Impact Index measuring sustainability metrics and carbon footprint</div>
              </div>
            </div>
          </div>
        </section>

      <div class="dashboard-stage" data-role="panel-stage" hidden></div>

        <section id="automationPanel" class="dashboard-panel dashboard-panel--automation" data-panel="automation">
          <div class="automation-drawer" role="region" aria-label="Automation drawer">
            <section id="smartControllersPanel" class="card hud-shell gr-card automation-drawer__card" aria-label="Smart controller manager">
              <div class="row row--between row--center hud-shell__header">
                <h2 class="hud-shell__title">
                  Smart Controllers
                  <span class="hint" tabindex="0" data-tip="Discover and orchestrate smart controllers including SwitchBot, Kasa, Shelly, and GreenReach ecosystems. Monitor statuses, assign equipment, and launch setup wizards for new integrations.">?</span>
                </h2>
                <div class="row row--gap-sm row--wrap row--align-start">
                  <button id="btnScanSmartControllers" type="button" class="primary" title="Scan for all smart controllers">Scan for Controllers</button>
                  <div class="smart-controller-action-group" role="group" aria-label="Device managers">
                    <span class="tiny text-muted" style="letter-spacing:0.02em;text-transform:uppercase;font-weight:600;">Device managers</span>
                    <div class="row row--gap-xs">
                      <button id="btnOpenSmartPlugsPanel" type="button" class="ghost">Smart Plugs</button>
                      <button id="btnOpenSwitchBotManager" type="button" class="ghost">SwitchBot Manager</button>
                    </div>
                  </div>
                  <!-- Modal for SwitchBot Manager -->
                  <div id="switchBotModal" class="modal" style="display:none;position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
                    <div style="background:#fff;border-radius:10px;max-width:90vw;max-height:90vh;width:900px;box-shadow:0 8px 32px rgba(0,0,0,0.25);position:relative;display:flex;flex-direction:column;">
                      <button id="closeSwitchBotModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;z-index:2;">&times;</button>
                      <iframe id="switchBotIframe" src="./switchbot.html" style="width:100%;height:80vh;border:none;border-radius:0 0 10px 10px;"></iframe>
                    </div>
                  </div>
                  <div class="smart-controller-action-group" role="group" aria-label="Device setup">
                    <span class="tiny text-muted" style="letter-spacing:0.02em;text-transform:uppercase;font-weight:600;">Device setup</span>
                    <div class="row row--gap-xs">
                      <button id="btnShowSmartControllersSetup" type="button" class="ghost">View setup options</button>
                    </div>
                  </div>
                </div>
                <div id="smartControllersSetupCard" class="card gr-card" style="display:none;margin:16px 0 0 0;padding:20px 24px 16px 24px;background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;">
                  <div style="display:flex;flex-direction:column;gap:4px;margin-bottom:12px;">
                    <span class="tiny text-muted" style="letter-spacing:0.02em;text-transform:uppercase;font-weight:600;">Device setup options</span>
                    <p class="tiny" style="margin:0;color:#475569;">Choose an ecosystem to start configuration for new hardware integrations.</p>
                  </div>
                  <div class="row row--gap-xs" id="smartControllersSetupButtons" style="flex-wrap:wrap;">
                    <button class="ghost" id="btnMgrKasa">Kasa</button>
                    <button class="ghost" id="btnMgrSonoff">Sonoff</button>
                    <button class="ghost" id="btnMgrShelly">Shelly</button>
                    <button class="ghost" id="btnMgrTuya">Tuya</button>
                    <button class="ghost" id="btnMgrHue">Hue</button>
                    <button class="ghost" id="btnMgrLIFX">LIFX</button>
                    <button class="ghost" id="btnMgrMeross">Meross</button>
                    <button class="ghost" id="btnMgrAqara">Aqara</button>
                    <button class="ghost" id="btnMgrTasmota">Tasmota/ESPHome</button>
                  </div>
                </div>
                <!-- Generic IoT Ecosystem Modal -->
                <div id="smartControllersModal" class="modal" style="display:none;position:fixed;z-index:10001;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
                  <div id="smartControllersModalContent" style="background:#fff;border-radius:10px;max-width:90vw;max-height:90vh;width:420px;box-shadow:0 8px 32px rgba(0,0,0,0.25);position:relative;display:flex;flex-direction:column;padding:32px 24px 24px 24px;">
                    <button id="closeSmartControllersModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;z-index:2;">&times;</button>
                    <div id="smartControllersModalBody"></div>
                  </div>
                </div>
              </div>
              <div id="smartControllersScanBarContainer" style="margin:12px 0 0 0;display:none;">
                <div id="smartControllersScanBar" style="position:relative;width:100%;height:22px;background:#e0e7ef;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px #0001;">
                  <div id="smartControllersScanBarFill" style="height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#34d399);transition:width 0.2s cubic-bezier(.4,2,.6,1);display:flex;align-items:center;justify-content:center;">
                    <span id="smartControllersScanBarPercent" style="position:absolute;width:100%;text-align:center;font-weight:bold;color:#222;letter-spacing:0.5px;">0%</span>
                  </div>
                </div>
              </div>
              <p class="tiny hud-shell__supporting-text">Discover, configure, and monitor connected controllers spanning SwitchBot sensors, Kasa smart plugs, Shelly relays, and GreenReach grow lights. Launch scans to locate hardware, manage ecosystems, and open advanced managers without leaving this workspace.</p>

              <div id="smartControllersList" class="smart-controllers-list">
                <!-- Unknown Devices Table will be rendered here -->
                <div id="unknownDevicesTable" style="margin-bottom:24px;"></div>
                <!-- IoT device cards by manufacturer will be loaded here -->
              </div>
            </section>

            <section id="smartPlugsPanel" class="card hud-shell gr-card automation-drawer__card" aria-label="Smart plug telemetry">
              <div class="row row--between row--center hud-shell__header">
                <h2 class="hud-shell__title">Smart Plugs</h2>
                <div class="row row--gap-xs">
                  <button id="btnRefreshSmartPlugs" type="button" class="ghost">Refresh</button>
                  <button id="btnDiscoverSmartPlugs" type="button" class="primary">Discover</button>
                </div>
              </div>
              <p class="tiny hud-shell__supporting-text" data-width="wide">
                Manage Shelly, Kasa, Tasmota, and SwitchBot plugs that control HVAC, dehumidifiers, and circulation fans. Toggle power, inspect live wattage, and attach rule guardrails per room scope.
              </p>
              <div id="smartPlugsAlert" class="alert" role="status" aria-live="polite" hidden></div>
              <div class="table" id="smartPlugsTable" role="region" aria-live="polite"></div>
            </section>

            <section id="roomAutomationCard" class="card hud-shell std automation-card gr-card automation-drawer__card" aria-labelledby="automationCardTitle">
              <header class="automation-card__header">
                <div>
                  <h2 id="automationCardTitle" class="section-title hud-shell__title">Automation Rules</h2>
                  <p class="tiny text-muted">Advisory guardrails for climate, spectrum, and air handling.</p>
                </div>
                <div class="automation-card__mode" role="group" aria-label="Automation mode">
                  <span class="automation-card__mode-label" data-role="automation-mode-label">Advisory</span>
                  <div class="automation-card__mode-toggle">
                    <button type="button" class="automation-mode-btn is-active" data-mode="advisory">Advisory</button>
                    <button type="button" class="automation-mode-btn" data-mode="autopilot" aria-disabled="true" data-tip="Autopilot coming soon">Autopilot</button>
                  </div>
                </div>
              </header>
              <div class="automation-card__body" data-role="automation-body"></div>
              <footer class="automation-card__footer">
                <span class="tiny text-muted" data-role="automation-status">Loading…</span>
              </footer>
            </section>

            <section id="aiAdvisoryCard" class="card hud-shell std ai-advisory-card gr-card gr-full automation-drawer__card" aria-labelledby="aiAdvisoryTitle">
              <header class="ai-advisory-card__header">
                <div>
                  <h2 id="aiAdvisoryTitle" class="section-title hud-shell__title">AI Copilot Advisory</h2>
                  <p class="tiny text-muted">Narrative insights from Temp · RH · VPD · PPFD vs. energy draw.</p>
                </div>
                <div class="ai-advisory-card__actions">
                  <button type="button" class="ghost" data-role="ai-copilot-close">Back to Overview</button>
                  <span class="badge badge--ai">Advisory</span>
                </div>
              </header>
              <p class="ai-advisory-card__summary" data-role="ai-summary">Loading Copilot narrative…</p>
              <div class="ai-advisory-card__body" data-role="ai-rooms"></div>
            </section>
          </div>
        </section>

  <!-- Current Lights Status card removed -->
    <!-- Overview hero (now below lights status) -->
      <section class="dashboard-panel dashboard-panel--overview is-active" data-panel="overview">
      <section id="overview" class="overview gr-card" aria-labelledby="overviewTitle">
        <header class="overview__hdr">
          <div>
            <h1 id="overviewTitle">Overview</h1>
            <p class="overview__subtitle">Tour-ready status for every grow room</p>
          </div>
          <div class="overview__legend" aria-label="Status legend">
            <span class="overview__legend-item"><span data-icon-slot="ai" data-icon-label="AI status" data-icon-static="true"></span>AI</span>
            <span class="overview__legend-item"><span data-icon-slot="auto" data-icon-label="Automation status" data-icon-static="true"></span>Automation</span>
            <span class="overview__legend-item"><span data-icon-slot="spectra" data-icon-label="SpectraSync status" data-icon-static="true"></span>SpectraSync</span>
            <div class="overview__demo" role="group" aria-label="Demo mode controls">
              <label for="demoRoom">Room</label>
              <select id="demoRoom" name="demoRoom" aria-label="Demo room"></select>
              <label for="demoBpm">BPM</label>
              <input id="demoBpm" type="number" min="60" max="140" step="1" value="90" aria-label="Demo tempo">
              <button id="demoStart" type="button" class="primary">Start Demo</button>
              <button id="demoStop" type="button" class="ghost" disabled>Stop</button>
            </div>
            <button id="btnOpenAiCopilot" type="button" class="primary overview__legend-button">Open AI Copilot</button>
          </div>
        </header>
        <div id="overviewGrid" class="overview__grid" aria-live="polite"></div>
      </section>
    </section>
      <section id="farmPanel" class="card card--compact hud-shell gr-card" data-panel="farm-registration">
              <header class="panel-header">
                <div>
                  <h2>Farm Registration</h2>
                  <span class="hint" tabindex="0" data-tip="Guided setup to get the reTerminal online, capture the farm address, and map Rooms/Zones. We save as we go and collapse to a summary badge when complete.">?</span>
                </div>
                <div class="row row--gap-xs">
                  <button id="btnLaunchFarm" type="button" class="primary">Register Farm</button>
                  <button id="btnEditFarm" type="button" class="primary pulse-button cta-start is-hidden">Start here</button>
                </div>
              </header>
              <div class="panel-summary">
                <span class="tiny text-muted">Status</span>
                <span id="farmSummaryChip" class="summary-chip"></span>
              </div>
      <div id="farmPanelBody" class="panel-body">
                <div id="farmBadge" class="farm-summary is-hidden"></div>
                <!-- <button id="btnStartDeviceSetup" type="button" class="ghost is-hidden">Continue device setup</button> -->
              </div>
            </section>
      <section id="roomsPanel" class="card card--compact hud-shell gr-card" data-panel="grow-rooms">
              <header class="panel-header">
                <div>
                  <h2>Grow Rooms</h2>
                  <span class="hint" tabindex="0" data-tip="Set up rooms with layout, fixtures, schedule, sensors, and energy monitoring. Saved rooms appear below.">?</span>
                </div>
                <button id="btnLaunchRoom" type="button" class="primary">New Grow Room</button>
              </header>
      <div id="roomsPanelBody" class="panel-body">
                <div id="roomsList"></div>
              </div>
            </section>
      <section id="lightsPanel" class="card card--compact hud-shell gr-card" data-panel="light-setup">
              <header class="panel-header">
                <div>
                  <h2>Light Setup</h2>
                  <span class="hint" tabindex="0" data-tip="Set up grow lights across rooms. We carry forward devices discovered in deep scans.">?</span>
                </div>
                <button id="btnLaunchLightSetup" type="button" class="primary">New Light Setup</button>
              </header>
      <div id="lightsPanelBody" class="panel-body">
                <div id="lightSetupSummary" class="panel-callout">
                  <!-- Summary will be populated by JavaScript -->
                </div>
                <div id="lightSetupsList"></div>
              </div>
            </section>

<section id="pairDevicesPanel" class="card hud-shell gr-card" data-panel="pair-devices">
  <div class="row row--between row--center hud-shell__header">
    <div>
      <h2 class="section-title hud-shell__title">Pair Devices</h2>
      <p class="tiny text-muted">Link new controllers, sensors, and fixtures to the dashboard.</p>
    </div>
    <span id="pairDevicesStatus" class="tiny" aria-live="polite"></span>
  </div>
  <p class="tiny hud-shell__supporting-text">Walk through Wi‑Fi, Bluetooth, and wired pairing with contextual AI assistance. We detect network details, confirm hub requirements, and document installation notes.</p>
  <div class="row row--gap-sm row--wrap">
  <button id="btnLaunchPairWizard" type="button" class="primary">Start Pairing Wizard</button>
<!-- Modal for Pairing Wizard (BLE/MQTT/Bluetooth) -->
<div id="pairWizardModal" class="modal" style="display:none;position:fixed;z-index:10000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:10px;max-width:90vw;max-height:90vh;width:600px;box-shadow:0 8px 32px rgba(0,0,0,0.25);position:relative;display:flex;flex-direction:column;">
    <button id="closePairWizardModal" style="position:absolute;top:10px;right:10px;background:none;border:none;font-size:1.5em;cursor:pointer;z-index:2;">&times;</button>
    <div id="pairWizardContent" style="padding:32px 24px 24px 24px;overflow-y:auto;max-height:80vh;">
      <h2 style="margin-top:0">Device Pairing Wizard</h2>
      <p class="tiny">This wizard will walk you through scanning for BLE/MQTT devices and Bluetooth pairing. (Demo placeholder: actual wizard logic to be integrated here.)</p>
      <div style="margin:24px 0;text-align:center;">
        <button class="primary" onclick="window.demoPairScan()">Scan for BLE/MQTT Devices</button>
        <div id="demoPairScanResults" style="margin-top:16px;"></div>
      </div>
    </div>
  </div>
</div>
    <button id="btnPairWizardDocs" type="button" class="ghost">Pairing checklist</button>
  </div>
</section>

          <section id="controllerAssignmentsPanel" class="card card--panel hud-shell gr-card" data-panel="control-assignments">
            <div class="row row--between row--center hud-shell__header">
              <h2 class="section-title hud-shell__title">
                Controller Assignments
                <span class="hint" tabindex="0" data-tip="Assign controllers to equipment requiring smart control (lights, HVAC, sensors).">?</span>
              </h2>
              <div class="row row--gap-xs">
                <button id="btnRefreshControllerAssignments" type="button" class="ghost">Refresh</button>
                <button id="btnManageControllers" type="button" class="primary">Manage Controllers</button>
              </div>
            </div>

            <!-- Controller Assignments Table (now directly in the card panel) -->
            <div id="controllerAssignmentsTable" class="panel-body">
              <!-- Table will be populated by JavaScript -->
            </div>
          </section>
      <section id="plansPanel" class="card hud-shell gr-card" data-panel="plans">
            <div class="row row--between row--center hud-shell__header">
              <h2 class="section-title hud-shell__title">
                Plans (Grow recipes)
                <span class="hint" tabindex="0" data-tip="Create and manage grow recipes. Each plan defines a spectrum mix and a target DLI. Preview spectrum, see where used, and assign later to Groups. DLI = PPFD × 3600 × photoperiod ÷ 1e6.">?</span>
              </h2>
              <span id="plansStatus" class="tiny" aria-live="polite"></span>
            </div>
            <div class="row row--gap-sm row--wrap mt-sm mb-sm">
              <button id="btnAddPlan" type="button" class="ghost">Add Plan</button>
              <button id="btnSavePlans" type="button" class="primary">Save Plans</button>
              <button id="btnDownloadPlans" type="button" class="ghost">Download</button>
              <button id="btnUploadPlans" type="button" class="ghost">Upload</button>
              <input id="plansUpload" type="file" accept="application/json" class="sr-only" />
            </div>
            <div id="plansList" class="grid cols-2 gap-sm" aria-live="polite"></div>
          </section>
      <!-- <section id="schedulesPanel" class="card" data-panel="schedules" style="display:none"> ...original schedule setup card hidden after embedding in Group V2... </section> -->
      <section id="calibrationPanel" class="card hud-shell gr-card" data-panel="calibration">
            <div class="row row--between row--center hud-shell__header">
              <h2 class="hud-shell__title">
                Calibration
                <span class="hint" tabindex="0" data-tip="Match lights to a target using controller or meter readings. Gains apply at send-time as a correction layer.">?</span>
              </h2>
              <span id="calStatus" class="tiny" aria-live="polite"></span>
            </div>
            <p class="tiny hud-shell__supporting-text">Pick a scope (Light, Group, or Location), choose a target light, and preview corrections before applying. Calibrations store per-light gains that wrap all future writes.</p>
            <div class="row row--gap-sm row--wrap mb-md">
              <button id="btnOpenCalWizard" type="button" class="primary">Open Calibration Wizard</button>
              <button id="btnReloadCal" type="button" class="ghost">Reload Profiles</button>
            </div>
            <div id="calibrationRegistry" class="cal-registry"></div>
          </section>

<section id="profilePanel" class="card hud-shell gr-card" data-panel="profile">
  <div class="row row--between row--center hud-shell__header">
    <h2 class="hud-shell__title">Profile</h2>
    <span id="profileStatus" class="tiny" aria-live="polite"></span>
  </div>
  <p class="tiny hud-shell__supporting-text">Manage the farm operator details and contact preferences used across reports and support requests.</p>
  <form id="profileForm" class="grid cols-2 profile-form">
    <label class="tiny">Name
      <input id="profileName" type="text" placeholder="Operator name" autocomplete="name">
    </label>
    <label class="tiny">Role
      <input id="profileRole" type="text" placeholder="e.g., Head Grower">
    </label>
    <label class="tiny">Email
      <input id="profileEmail" type="email" placeholder="name@example.com" autocomplete="email">
    </label>
    <label class="tiny">Phone
      <input id="profilePhone" type="tel" placeholder="+1 (555) 123-4567" autocomplete="tel">
    </label>
    <div class="row row--gap-sm profile-form__actions">
      <button id="profileSave" type="submit" class="primary">Save Profile</button>
      <button id="profileReset" type="button" class="ghost">Reset</button>
    </div>
  </form>
      </section>
      </div>

      <!-- Groups V2 Panel -->
      <section id="groupsV2Panel" class="card hud-shell gr-card" data-panel="groups-v2" data-card-prefix="GR" data-card-code="GV2" hidden>
      <div class="row row--between row--center hud-shell__header">
        <h2 class="hud-shell__title">Group V2 Setup</h2>
        <span id="groupsV2Status" class="tiny" aria-live="polite"></span>
      </div>
      <div class="panel-body gr-grid">
  <div class="row group-v2-builder gr-card" style="margin-bottom:16px; align-items: flex-end; gap: 16px; flex-wrap: wrap; border: 1.5px solid #cbd5e1; background: linear-gradient(90deg, #f8fafc 80%, #e0f2fe 100%); border-radius: 10px; box-shadow: 0 2px 8px 0 rgba(100, 199, 199, 0.07); padding: 18px 18px 10px 18px;">
          <label for="groupsV2RoomSelect" style="margin-right:8px">Select Room:</label>
          <select id="groupsV2RoomSelect" style="margin-right:16px">
            <option value="GreenReach">GreenReach</option>
            <!-- Dynamic room options will be inserted here by JS -->
          </select>
          <label for="groupsV2ZoneSelect" style="margin-right:8px">Zone:</label>
          <select id="groupsV2ZoneSelect" style="margin-right:16px">
            <option value="">(none)</option>
            <option value="Zone 1">Zone 1</option>
            <option value="Zone 2">Zone 2</option>
            <option value="Zone 3">Zone 3</option>
            <option value="Zone 4">Zone 4</option>
            <option value="Zone 5">Zone 5</option>
            <option value="Zone 6">Zone 6</option>
            <option value="Zone 7">Zone 7</option>
            <option value="Zone 8">Zone 8</option>
            <option value="Zone 9">Zone 9</option>
            <option value="Zone 10">Zone 10</option>
          </select>
          <label for="groupsV2ZoneName" style="margin-right:8px">Name this zone:</label>
          <input id="groupsV2ZoneName" type="text" placeholder="e.g., Propagation North — Bench A" style="min-width:180px;">
          <button id="groupsV2SaveGroup" type="button" class="primary" style="margin-left:8px;">Save New Group</button>
          <label for="groupsV2LoadGroup" style="margin-left:16px; margin-right:8px;">Load Group:</label>
          <select id="groupsV2LoadGroup" style="max-width:180px;">
            <option value="">(none)</option>
            <!-- Saved groups will be populated here by JS -->
          </select>
        </div>
        <div id="groupsV2PlanForm" class="gr-card" style="margin-bottom:18px; border: 1.5px solid #cbd5e1; background: linear-gradient(90deg, #f8fafc 80%, #e0f2fe 100%); border-radius: 10px; box-shadow: 0 2px 8px 0 rgba(100, 199, 199, 0.07); padding: 18px 18px 16px 18px;">
          <div id="groupsV2PlanControls" style="margin-bottom:18px; padding:0 0 8px; border-bottom:1px dashed #bae6fd; display:flex; flex-direction:column; gap:12px;">
            <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">
              <label class="tiny" style="display:flex; flex-direction:column; min-width:220px;">
                Plan
                <select id="groupsV2PlanSelect" style="margin-top:4px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1; min-height:34px;">
                  <option value="">(none)</option>
                  <!-- Plans will be populated by JS -->
                </select>
              </label>
              <button id="applyPlanToGroupBtn" type="button" class="primary" style="margin-left:8px;">Apply to Current Plan</button>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">
              <label class="tiny" style="display:flex; flex-direction:column; min-width:220px;">
                Search plan
                <select id="groupsV2PlanSearch" style="margin-top:4px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1; min-height:34px;">
                  <option value="">All plans</option>
                </select>
              </label>
              <div class="tiny" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
                <span style="font-weight:600;">Anchor:</span>
                <label class="chip-option" style="margin-right:4px;"><input type="radio" name="groupsV2AnchorMode" value="seedDate" checked><span>Seed Date</span></label>
                <input id="groupsV2SeedDate" type="date" placeholder="YYYY-MM-DD" style="min-width:150px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
                <label class="chip-option" style="margin:0 4px 0 12px;"><input type="radio" name="groupsV2AnchorMode" value="dps"><span>DPS</span></label>
                <input id="groupsV2Dps" type="number" min="0" step="1" value="1" style="width:90px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
              </div>
            </div>
          </div>
          <div style="margin-top:12px; display:flex; flex-direction:column; gap:12px;">
            <div class="tiny" style="display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
              <span style="font-weight:600; display:inline-flex; align-items:center; gap:4px;">
                Grow day cycles
                <span title="Two cycles split the day into two 12 h windows. Cycle B always begins when Cycle A's off window ends." style="cursor:help; font-size:0.85em; color:#64748b;">ⓘ</span>
              </span>
              <label class="chip-option"><input type="radio" name="groupsV2ScheduleMode" value="one" checked><span>One cycle</span></label>
              <label class="chip-option"><input type="radio" name="groupsV2ScheduleMode" value="two"><span>Two cycles</span></label>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-start;">
              <div class="tiny" style="display:flex; flex-direction:column; gap:6px; min-width:160px; padding:12px; border:1px solid #cbd5e1; border-radius:8px; background:#f8fafc;">
                <div style="font-weight:600;">Cycle 1</div>
                <label style="display:flex; flex-direction:column; gap:4px;">
                  <span>Start</span>
                  <input id="groupsV2Cycle1On" type="time" value="08:00" style="padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
                </label>
                <label style="display:flex; flex-direction:column; gap:4px;">
                  <span>ON duration (h)</span>
                  <input id="groupsV2Cycle1Hours" type="number" min="0" max="24" step="0.25" value="12" style="padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
                </label>
                <div id="groupsV2Cycle1End" class="tiny text-muted">End: 20:00</div>
                <div class="tiny text-muted">Repeated daily</div>
              </div>
              <div id="groupsV2Cycle2Container" class="tiny" style="display:none; flex-direction:column; gap:6px; min-width:160px; padding:12px; border:1px solid #cbd5e1; border-radius:8px; background:#f0f9ff;">
                <div style="font-weight:600;">Cycle 2</div>
                <label style="display:flex; flex-direction:column; gap:4px;">
                  <span>Start (auto)</span>
                  <input id="groupsV2Cycle2On" type="time" value="20:00" readonly aria-readonly="true" style="padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1; background:#e2e8f0; color:#475569;">
                </label>
                <label style="display:flex; flex-direction:column; gap:4px;">
                  <span>ON duration (h, auto)</span>
                  <input id="groupsV2Cycle2Hours" type="number" min="0" max="24" step="0.5" value="12" readonly aria-readonly="true" style="padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1; background:#e2e8f0; color:#475569;">
                </label>
                <div id="groupsV2Cycle2End" class="tiny text-muted">End: 08:00</div>
                <div class="tiny text-muted">Repeated daily • Auto-calculated</div>
              </div>
            </div>
            <div class="tiny" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:4px;">
              <button id="groupsV2SplitEvenBtn" type="button" class="secondary" style="padding:4px 10px; border-radius:999px;">Split evenly (6/6)</button>
              <button id="groupsV2MaxLightBtn" type="button" class="secondary" style="padding:4px 10px; border-radius:999px;">Maximize light (11/1)</button>
              <button id="groupsV2ResetRampsBtn" type="button" class="secondary" style="padding:4px 10px; border-radius:999px;">Reset ramps</button>
            </div>
            <div id="groupsV2ScheduleSummary" class="tiny text-muted"></div>
          </div>
          <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:16px;">
            <label class="tiny" style="display:flex; flex-direction:column; min-width:110px;">
              PPFD Δ (µmol)
              <input id="groupsV2GradientPpfd" type="number" step="1" value="0" style="margin-top:4px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
            </label>
            <label class="tiny" style="display:flex; flex-direction:column; min-width:110px;">
              Blue Δ (%)
              <input id="groupsV2GradientBlue" type="number" step="0.5" value="0" style="margin-top:4px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
            </label>
            <label class="tiny" style="display:flex; flex-direction:column; min-width:120px;">
              Temp Δ (°C)
              <input id="groupsV2GradientTemp" type="number" step="0.5" value="0" style="margin-top:4px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
            </label>
            <label class="tiny" style="display:flex; flex-direction:column; min-width:110px;">
              RH Δ (%)
              <input id="groupsV2GradientRh" type="number" step="0.5" value="0" style="margin-top:4px; padding:6px 8px; border-radius:6px; border:1px solid #cbd5e1;">
            </label>
          </div>
          <div class="tiny text-muted" style="margin-top:6px;">Gradients adjust plan targets before saving so downstream cards can layer the offsets.</div>
        <div id="groupsV2PlanPreview" class="gr-card" style="margin-top:14px; padding:12px 14px; background:linear-gradient(90deg, #f0f9ff 0%, #e0f2fe 100%); border:1px dashed #38bdf8; border-radius:8px; font-size:0.9em; line-height:1.5;">
          <div class="tiny text-muted">Select a plan to preview today’s stage, PPFD, photoperiod, and DLI.</div>
        </div>
        <!-- GRAL29: Selected lights list with delete action -->
        <section id="GRAL29" class="gr-card">
          <div class="card-hd">
            <h3>Lights (GRAL29)</h3>
            <div class="actions">
              <button id="gral29-delete" type="button" class="btn btn-danger" title="Delete selected lights">Delete Selected</button>
            </div>
          </div>
          <div class="card-bd">
            <div id="gral29-light-list" class="gral29-list" aria-live="polite"></div>
          </div>
        </section>

        <!-- Selected Light(s) Spectra (renders under the Plan Spectra) -->
        <section id="light-spectra-wrap" class="gr-card">
          <h3>Selected Light Spectra</h3>
          <div id="light-spectra-graphs"></div>

          <div id="light-plan-delta" class="delta-grid" aria-live="polite">
            <!-- Filled by JS: a table of Δ% for Blue / Mid(Green) / Red per selected light -->
          </div>
        </section>
      </div>
      <div class="group-v2-card gr-card" data-card-code="UE" style="margin-bottom:18px; border: 1.5px solid #cbd5e1; background: linear-gradient(90deg, #f8fafc 80%, #e0f2fe 100%); border-radius: 10px; box-shadow: 0 2px 8px 0 rgba(100, 199, 199, 0.07); padding: 0; width:100%; font-family: var(--gr-font, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif);">
          <div style="display:flex; flex-direction:column; width:100%; min-height:100px; background:#f6f8fa; border-radius:8px 8px 0 0; padding:18px 18px 10px 18px;">
            <h4 style="margin:0 0 8px 0; font-size:1.1em; color:#334155; font-weight:600;">Unassigned Equipment</h4>
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <label for="groupsV2UnassignedEquipSelect" style="margin-right:8px; font-size:1em; color:#334155;">Unassigned Equipment:</label>
              <select id="groupsV2UnassignedEquipSelect" multiple size="3" style="min-width:180px; font-size:1em;">
                <!-- Equipment will be populated by JS -->
              </select>
              <button id="assignEquipToZoneBtn" style="margin-left:16px; font-size:1em;">Assign to Zone</button>
            </div>
          </div>
        </div>
        <div class="group-v2-card gr-card" data-card-code="AE" style="margin-bottom:18px; border: 1.5px solid #cbd5e1; background: linear-gradient(90deg, #f8fafc 80%, #e0f2fe 100%); border-radius: 10px; box-shadow: 0 2px 8px 0 rgba(100, 199, 199, 0.07); padding: 0; width:100%; font-family: var(--gr-font, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif);">
          <div style="display:flex; flex-direction:column; width:100%; min-height:100px; background:#e0f7fa; border-radius:8px 8px 0 0; padding:18px 18px 10px 18px;">
            <h4 style="margin:0 0 8px 0; font-size:1.1em; color:#334155; font-weight:600;">Assigned Equipment</h4>
            <select id="assignedEquipSelect" multiple size="3" style="min-width:180px; font-size:1em; margin-bottom:10px;">
              <!-- Assigned equipment will be populated by JS -->
            </select>
            <ul id="assignedEquipList" style="display:none;"></ul>
          </div>
        </div>
        <div class="group-v2-card gr-card" data-card-code="UL" style="margin-bottom:18px; border: 1.5px solid #cbd5e1; background: linear-gradient(90deg, #f8fafc 80%, #e0f2fe 100%); border-radius: 10px; box-shadow: 0 2px 8px 0 rgba(100, 199, 199, 0.07); padding: 0; width:100%; font-family: var(--gr-font, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif);">
          <div style="display:flex; flex-direction:column; width:100%; min-height:100px; background:#f1f5f9; border-radius:8px 8px 0 0; padding:18px 18px 10px 18px;">
            <h4 style="margin:0 0 8px 0; font-size:1.1em; color:#334155; font-weight:600;">Unassigned Lights</h4>
            <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
              <label for="groupsV2UnassignedLightsSelect" style="margin-right:8px; font-size:1em; color:#334155;">Unassigned Lights:</label>
              <select id="groupsV2UnassignedLightsSelect" multiple size="6" style="min-width:320px; max-width:600px; height:176px; font-size:1em;">
                <!-- Lights will be populated by JS -->
              </select>
              <button id="assignLightsToGroupBtn" style="margin-left:16px; font-size:1em;">Assign to Group</button>
            </div>
            <div id="lightInfoCard" style="flex:1 1 auto; overflow-y:auto; display:none;">
              <h4 id="lightInfoCardTitle" style="margin-top:0; margin-bottom:8px; font-size:1.1em; color:#334155; font-weight:600;">Light Info</h4>
              <div id="lightInfoCardBody" style="font-size:0.98em; color:#334155;"></div>
            </div>
          </div>
        </div>
        <p class="tiny" style="color:#475569">This is the new Groups V2 setup card. Add your new group management features here.</p>
        <!-- TODO: Add Groups V2 UI here -->
        </div>
        </section>

        <section id="gr-unassigned-panel" class="panel">
          <h2>Unassigned Lights</h2>
          <div id="GRUL32" class="gr-list"></div>
          <div class="row gap8">
            <button id="GRUL32-apply">Add →</button>
            <button id="GRUL32-clear">Clear</button>
          </div>
        </section>

        <section id="gr-active-cards" class="panel">
          <h2>Active Cards</h2>
          <div id="GRACB28" class="cards grid"></div>
        </section>

        <section id="gr-spectra" class="panel">
          <h2>Spectragraph</h2>
          <div id="GVPFLSW29" class="spectra"></div>
        </section>

      </div>

    </main>

  <!-- NEW FRESH Light Setup Modal -->
  <div id="freshLightModal" class="fresh-light-modal" aria-hidden="true">
    <div class="fresh-light-modal__backdrop"></div>
    <div class="fresh-light-modal__dialog">
      <div class="fresh-light-modal__header">
        <h2>Light Setup Wizard</h2>
        <button type="button" class="fresh-light-modal__close" id="freshLightClose">×</button>
      </div>
      
      <div class="fresh-light-modal__content">
        <div class="fresh-light-step" id="freshStep1" data-active>
          <h3>Select Room and Zone</h3>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px;">Room:</label>
            <select id="freshRoomSelect" style="width: 100%; padding: 8px; font-size: 14px;">
              <option value="">Select a room</option>
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 8px;">Zone:</label>
            <select id="freshZoneSelect" style="width: 100%; padding: 8px; font-size: 14px;">
              <option value="">Select a zone</option>
            </select>
          </div>
          
          <button id="freshCreateZone" type="button" style="padding: 8px 16px;">Create New Zone</button>
        </div>
        
        <div class="fresh-light-step" id="freshStep2">
          <h3>Select Fixtures</h3>
          
          <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 13px;">Lights per controller:</span>
                <input id="freshLightSeriesCount" type="number" min="0" value="1" style="width: 80px; padding: 4px;">
              </label>
              <label style="display: flex; align-items: center; gap: 6px;">
                <span style="font-size: 13px;">Number of controllers:</span>
                <input id="freshControllersCount" type="number" min="0" value="1" style="width: 80px; padding: 4px;">
              </label>
            </div>
            
            <div style="margin-bottom: 12px;">
              <label style="display: block; margin-bottom: 8px; font-size: 13px;">Search fixtures:</label>
              <input id="freshFixtureSearch" type="text" placeholder="Search models (e.g., Gavita 1700e)" 
                     style="width: 100%; padding: 8px; font-size: 14px;">
            </div>
            
            <div style="margin-bottom: 12px;">
              <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Search Results:</div>
              <div id="freshFixtureResults" style="max-height: 150px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 4px; min-height: 60px;">
                <div style="padding: 20px; text-align: center; color: #64748b; font-size: 13px;">
                  Type to search for fixture models...
                </div>
              </div>
            </div>
            
            <div>
              <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Selected Fixtures:</div>
              <div id="freshSelectedFixtures" style="min-height: 60px; border: 1px solid #e2e8f0; border-radius: 4px; padding: 8px;">
                <div style="color: #64748b; font-size: 13px;">No fixtures selected yet</div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="fresh-light-step" id="freshStep3">
          <h3>Control Method</h3>
          
          <div style="margin-bottom: 20px;">
            <div style="font-size: 13px; margin-bottom: 12px;">How will the fixtures be controlled?</div>
            
            <div id="freshControlMethod" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px;">
              <button type="button" class="fresh-control-option" data-value="wifi">Wi‑Fi / App</button>
              <button type="button" class="fresh-control-option" data-value="smart-plug">Smart Plug</button>
              <button type="button" class="fresh-control-option" data-value="0-10v">0‑10V / Wired</button>
              <button type="button" class="fresh-control-option" data-value="rs485">RS‑485 / Modbus</button>
              <button type="button" class="fresh-control-option" data-value="other">Other</button>
            </div>
            
            <div id="freshControlDetails" style="font-size: 13px; color: #64748b; padding: 12px; background: #f8fafc; border-radius: 4px; display: none;">
              Control method details will appear here...
            </div>
          </div>
        </div>
        
        <div class="fresh-light-step" id="freshStep4">
          <h3>Review Setup</h3>
          
          <div style="margin-bottom: 20px;">
            <div id="freshReviewSummary" style="background: #f8fafc; border-radius: 8px; padding: 16px;">
              <div style="font-weight: 600; margin-bottom: 12px;">Light Setup Summary</div>
              <div id="freshReviewDetails" style="font-size: 14px; line-height: 1.5;">
                <!-- Review details will be populated here -->
              </div>
            </div>
            
            <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
              <div style="font-size: 13px; color: #92400e;">
                <strong>Ready to save:</strong> This will create your light setup configuration for the selected room and zone.
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="fresh-light-modal__footer">
        <button id="freshPrev" type="button" style="display: none;">Previous</button>
        <button id="freshNext" type="button">Next</button>
        <button id="freshSave" type="button" style="display: none;">Save</button>
      </div>
    </div>
  </div>
          <section class="light-step" data-step="fixtures">
            <p class="light-question">Select fixtures and counts.</p>
            <div class="farm-step__stack">
              <div class="row row--gap-sm row--center row--wrap mb-xs">
                <label class="tiny">How many lights per controller?
                  <input id="lightSeriesCount" type="number" min="0" value="0" style="width:120px;margin-left:6px">
                </label>
                <label class="tiny">Number of controllers
                  <input id="lightControllersCount" type="number" min="0" value="0" style="width:120px;margin-left:6px">
                </label>
              </div>
              <input id="lightKbSearch" type="text" placeholder="Search models (e.g., Gavita 1700e)" autocomplete="off">
              <div class="tiny" style="color:#64748b">Results</div>
              <ul id="lightKbResults" class="farm-kb-results" aria-live="polite"></ul>
              <div class="tiny" style="color:#64748b">Selected</div>
              <ul id="lightKbSelected" class="farm-kb-selected" aria-live="polite"></ul>
            </div>
          </section>
          <section class="light-step" data-step="control">
            <p class="light-question">How will the fixtures be controlled?</p>
            <div class="farm-step__stack">
              <div class="tiny">Control method</div>
              <div id="lightControlMethod" class="chip-row" role="group" aria-label="Control method">
                <button type="button" class="chip-option" data-value="wifi">Wi‑Fi / App</button>
                <button type="button" class="chip-option" data-value="smart-plug">Smart plug</button>
                <button type="button" class="chip-option" data-value="0-10v">0‑10V / Wired</button>
                <button type="button" class="chip-option" data-value="rs485">RS‑485 / Modbus</button>
                <button type="button" class="chip-option" data-value="other">Other</button>
              </div>
              <div id="lightControlDetails" style="margin-top:8px" class="tiny" aria-live="polite"></div>
            </div>
          </section>
          <section class="light-step" data-step="add-more">
            <p class="light-question">Add more lights to this room/zone?</p>
            <div class="farm-step__stack">
              <div id="lightSetupsSummary" class="light-setups-summary"></div>
              <div class="row row--gap-md mt-lg row--center justify-center">
                <button id="lightAddMoreSetup" type="button" class="primary">Add More Lights</button>
                <button id="lightFinishSetups" type="button" class="primary">Continue to Review</button>
              </div>
            </div>
          </section>
          <section class="light-step" data-step="review">
            <p class="light-question">Review light setup</p>
            <div id="lightReview" class="farm-review"></div>
          </section>
        </div>

      </form>
    </div>
  </div>
  <div id="envModal" class="env-modal" aria-hidden="true">
    <div class="env-modal__backdrop" id="envModalBackdrop"></div>
    <div class="env-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="envModalTitle">
      <button type="button" class="env-modal__close" id="envModalClose" aria-label="Close">×</button>
      <div class="env-modal__content">
        <h2 id="envModalTitle" style="margin:0 0 12px">Trend</h2>
        <p class="tiny" id="envModalSubtitle" style="margin:0 0 12px;color:#475569"></p>
        <div id="envModalChart" class="env-modal__chart"></div>
        <div id="envModalStats" class="env-modal__stats"></div>
      </div>
    </div>
  </div>

  <div id="calModal" class="cal-modal" aria-hidden="true">
    <div class="cal-modal__backdrop" id="calModalBackdrop"></div>
    <div class="cal-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="calModalTitle">
      <button type="button" class="cal-modal__close" id="calModalClose" aria-label="Close">×</button>
      <form id="calWizardForm" novalidate>
        <p class="tiny" id="calModalProgress" aria-live="polite">Step 1 of 5</p>
        <h2 id="calModalTitle" style="margin:0 0 12px">Calibration Wizard</h2>
        <div id="calSteps">
          <section class="cal-step" data-step="scope-type">
            <p class="cal-question">What do you want to calibrate?</p>
            <div class="cal-options" role="radiogroup" aria-label="Calibration scope">
              <label class="chip-option"><input type="radio" name="calScopeType" value="lights" checked><span>Specific lights</span></label>
              <label class="chip-option"><input type="radio" name="calScopeType" value="group"><span>Group</span></label>
              <label class="chip-option"><input type="radio" name="calScopeType" value="location"><span>Location</span></label>
            </div>
            <p class="tiny" style="color:#64748b">Lights scope lets you hand-pick devices. Group uses the roster. Location uses Room / Zone assignments.</p>
          </section>

          <section class="cal-step" data-step="scope-detail">
            <p class="cal-question">Select the fixtures to calibrate.</p>
            <div id="calScopeLights" class="cal-scope-block" aria-live="polite"></div>
            <div id="calScopeGroup" class="cal-scope-block" style="display:none">
            <div id="calScopeLocation" class="cal-scope-block" style="display:none">
              <div class="row row--gap-sm row--wrap">
                <label class="row row--gap-xs"><span>Room</span><select id="calScopeRoom"></select></label>
                <label class="row row--gap-xs"><span>Zone</span><select id="calScopeZone"></select></label>
              </div>
              <p class="tiny" style="color:#475569">Lights with matching Room/Zone assignments will be included.</p>
            </div>
            <p id="calScopeSummary" class="tiny" style="margin-top:8px;color:#0f172a"></p>
          </section>

          <section class="cal-step" data-step="target">
            <p class="cal-question">Choose the target light baseline.</p>
            <select id="calTargetSelect" style="min-width:240px"></select>
            <label class="row row--gap-xs mt-sm"><input id="calTargetReconfirm" type="checkbox"><span>Include target in calibration (reconfirm baseline)</span></label>
            <p id="calTargetNote" class="tiny" style="color:#b91c1c"></p>
          </section>

          <section class="cal-step" data-step="sequence">
            <div class="cal-sequence" id="calSequenceStage">
              <div class="cal-sequence__header">
                <p class="cal-question" id="calSequenceTitle">Run the calibration patterns.</p>
                <span class="tiny" id="calSequenceMeta"></span>
              </div>
              <p class="tiny" id="calSequenceDescription" style="color:#475569"></p>
              <div class="cal-sequence__actions">
                <button id="calSequenceSend" type="button" class="ghost">Send pattern</button>
                <button id="calSequenceReset" type="button" class="ghost">Restore baseline</button>
              </div>
              <div class="cal-sequence__body">
                <div class="cal-sequence__target">
                  <h3 class="tiny" style="margin:0;color:#0f172a">Target reading</h3>
                  <div id="calSequenceTarget"></div>
                </div>
                <div class="cal-sequence__lights" id="calSequenceLights" aria-live="polite"></div>
              </div>
              <div class="cal-sequence__footer">
                <div id="calSequenceChecklist" class="cal-sequence__status" aria-live="polite"></div>
                <div class="row row--gap-sm">
                  <button id="calSequencePrevTest" type="button" class="ghost">Previous pattern</button>
                  <button id="calSequenceNextTest" type="button" class="primary" disabled>Save & Next</button>
                </div>
              </div>
            </div>
          </section>

          <section class="cal-step" data-step="review">
            <p class="cal-question">Review the calibration preview.</p>
            <div id="calPreviewSummary" class="cal-preview-summary"></div>
            <div id="calPreviewTable" class="cal-preview-table" role="region" aria-live="polite"></div>
            <div id="calPreviewWarnings" class="cal-preview-warnings"></div>
          </section>
        </div>

        <div class="row cal-modal__footer" style="justify-content:space-between;margin-top:18px">
          <button id="calPrev" type="button" class="ghost">Back</button>
          <div class="row row--gap-sm">
            <button id="calDryRun" type="button" class="ghost" style="display:none">Recalculate</button>
            <button id="calNext" type="button" class="primary">Next</button>
            <button id="calApply" type="submit" class="primary" style="display:none">Apply Calibration</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <div id="roomModal" class="room-modal" aria-hidden="true">
    <div class="room-modal__backdrop" id="roomModalBackdrop"></div>
    <div class="room-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="roomModalTitle">
      <form id="roomWizardForm" novalidate style="display:flex; flex-direction:column; height:100%; min-height:0;">
        <!-- Close button at top -->
        <div style="display:flex; justify-content:flex-end; margin-bottom:16px;">
          <button type="button" class="room-modal__close" id="roomModalClose" aria-label="Close">×</button>
        </div>
        
        <!-- Header with progress, title, and navigation buttons -->
        <div class="room-modal__header" style="flex-shrink:0; display:flex; align-items:center; justify-content:space-between; padding:0 0 12px 0; border-bottom:1px solid #e2e8f0;">
          <div>
            <p class="tiny" id="roomModalProgress" aria-live="polite" style="margin:0 0 4px 0;">Step 1 of 5</p>
            <h2 id="roomModalTitle" style="margin:0;">Set up a Grow Room</h2>
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            <button id="roomTopPrev" type="button" class="ghost" style="font-size:12px; padding:6px 12px; display:none;">Previous</button>
            <button id="roomTopNext" type="button" class="primary" style="font-size:12px; padding:6px 12px;">Next</button>
            <button id="roomTopSaveClose" type="button" class="primary" style="font-size:12px; padding:6px 12px; display:none;">Save & Close</button>
          </div>
        </div>
        
        <div id="roomSteps" style="flex:1; overflow-y:auto; min-height:0; position:relative; padding-top:16px;">

          

          <section class="room-step" data-step="room-info">
            <p class="room-question">Name the grow room.</p>
            <div class="farm-step__stack">
              <div id="roomInfoError" class="tiny" style="color:#e11d48;margin-bottom:8px;display:none"></div>
              <label class="tiny" for="roomInfoName">Grow room name</label>
              <input id="roomInfoName" type="text" placeholder="e.g., Flower A" required>
            </div>
          </section>
          <section class="room-step" data-step="hardware">
            <p class="room-question">Which equipment are you setting up in this room?</p>
            <div class="farm-step__stack">
              <div id="hardwareError" class="tiny" style="color:#e11d48;margin-bottom:8px;display:none"></div>
              <div class="tiny">Select all that apply</div>
              <div id="roomHardwareCats" class="chip-row" role="group" aria-label="Hardware categories">
                <button type="button" class="chip-option" data-value="hvac">Central HVAC</button>
                <button type="button" class="chip-option" data-value="mini-split">Mini Split</button>
                <button type="button" class="chip-option" data-value="dehumidifier">Dehumidifier</button>
                <button type="button" class="chip-option" data-value="fans">Fans</button>
                <button type="button" class="chip-option" data-value="vents">Vents</button>
                <button type="button" class="chip-option" data-value="controllers">Controllers / hubs</button>
                <button type="button" class="chip-option" data-value="energy-monitor">Energy Monitor</button>
                <button type="button" class="chip-option" data-value="other">Other</button>
              </div>
              <!-- Removed the hardware search UI here to reduce confusion; use Fixtures or Devices steps instead. -->
            </div>
          </section>

          <!-- Dynamic per-category setup host (used for HVAC, mini-split, dehumidifier, fans, vents, controllers, other) -->
          <section class="room-step" data-step="category-setup">
            <p class="room-question" id="catSetupTitle">Category setup</p>
            <p class="tiny" id="catSetupIntro" style="color:#475569">We’ll capture a quick count, control method, and energy metering for each device type.</p>
            <p class="tiny" id="catSetupStatusLine" aria-live="polite" style="color:#0f172a"></p>
            <div class="farm-step__stack" id="catSetupBody"></div>
            <p class="tiny" id="catSetupStatus" aria-live="polite" style="color:#0f172a"></p>
            <div class="row" id="catSetupNav" style="gap:8px;align-items:center;margin-top:8px;justify-content:center">
              <button type="button" class="ghost" id="catPrevType">Previous Equipment</button>
              <span class="tiny" id="catSetupProgress" style="color:#475569"></span>
              <button type="button" class="ghost" id="catNextType">Next Equipment</button>
            </div>
            </div>
          </section>



          <section class="room-step" data-step="review">
            <p class="room-question">Review this room before saving.</p>
            <div id="roomReview" class="farm-review"></div>
          </section>

        </div>

      </form>
    </div>
  </div>
  <!-- Device Pairing Modal (guided Wi‑Fi / Bluetooth setup) -->
  <div id="devicePairModal" class="device-pair-modal" aria-hidden="true">
    <div class="device-pair-modal__backdrop" id="devicePairBackdrop"></div>
    <div class="device-pair-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="devicePairTitle">
      <button type="button" class="device-pair-modal__close" id="devicePairClose" aria-label="Close">×</button>
      <form id="devicePairForm" novalidate>
        <p class="tiny" id="devicePairProgress" aria-live="polite">Step 1 of 3</p>
        <h2 id="devicePairTitle" style="margin:0 0 12px">Pair device</h2>
        <div id="devicePairSteps">
          <section class="pair-step" data-step="transport">
            <p class="pair-question">Which transport should we use to pair?</p>
            <div class="chip-row" id="pairTransport" role="radiogroup" aria-label="Transport">
              <label class="chip-option"><input type="radio" name="pairTransport" value="wifi" checked><span>Wi‑Fi</span></label>
              <label class="chip-option"><input type="radio" name="pairTransport" value="bluetooth"><span>Bluetooth</span></label>
            </div>
            <p class="tiny" style="color:#64748b">Select the transport that the device supports. The KB will suggest one.</p>
            <div id="pairTransportAiSuggestion" class="ai-suggestion" style="display:none">
              <div class="ai-suggestion__text tiny"></div>
              <button type="button" class="ghost ai-suggestion__apply">Accept AI suggestion</button>
            </div>
          </section>

          <section class="pair-step" data-step="wifi">
            <p class="pair-question">Wi‑Fi details</p>
            <div class="farm-step__stack">
              <input id="pairWifiSsid" type="text" placeholder="SSID" style="min-width:220px">
              <input id="pairWifiPsk" type="password" placeholder="Wi‑Fi password (PSK)" style="min-width:220px">
              <label class="tiny" style="align-items:center;display:flex;gap:6px"><input id="pairWifiStatic" type="checkbox"> Use static IP</label>
              <input id="pairWifiStaticIp" type="text" placeholder="Static IP (optional)" style="min-width:160px;display:none">
              <div class="tiny" style="color:#64748b;margin-top:8px">If the device uses AP-mode for initial setup, follow vendor instructions to connect to its temporary SSID and then return here to enter credentials.</div>
              <div id="pairWifiAiSuggestion" class="ai-suggestion" style="display:none">
                <div class="ai-suggestion__text tiny"></div>
                <button type="button" class="ghost ai-suggestion__apply">Accept AI suggestion</button>
              </div>
            </div>
          </section>

          <section class="pair-step" data-step="bluetooth">
            <p class="pair-question">Bluetooth pairing</p>
            <div class="farm-step__stack">
              <input id="pairBtName" type="text" placeholder="Advertised device name (optional)" style="min-width:260px">
              <input id="pairBtPin" type="text" placeholder="Pairing code (if any)" style="min-width:160px">
              <div class="tiny" style="color:#64748b;margin-top:8px">Most BLE sensors don't require a PIN. Use the advertised name to help find the device in scans or enter a known MAC/address here.</div>
              <div id="pairBtAiSuggestion" class="ai-suggestion" style="display:none">
                <div class="ai-suggestion__text tiny"></div>
                <button type="button" class="ghost ai-suggestion__apply">Accept AI suggestion</button>
              </div>
            </div>
          </section>

          <section class="pair-step" data-step="review">
            <p class="pair-question">Review pairing info</p>
            <div id="pairReview" class="farm-review tiny" style="color:#0f172a"></div>
            <div id="pairReviewAiSummary" class="ai-suggestion" style="display:none">
              <div class="ai-suggestion__text tiny"></div>
            </div>
          </section>
        </div>

        <div class="row device-pair-modal__footer" style="justify-content:space-between;margin-top:18px">
          <button id="pairPrev" type="button" class="ghost">Back</button>
          <div class="row row--gap-sm">
            <button id="pairNext" type="button" class="primary">Next</button>
            <button id="pairSave" type="submit" class="primary" style="display:none">Save & Add</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <div id="farmModal" class="farm-modal" aria-hidden="true">
    <div class="farm-modal__backdrop" id="farmModalBackdrop"></div>
    <div class="farm-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="farmModalTitle">
      <button type="button" class="farm-modal__close" id="farmModalClose" aria-label="Close">×</button>
      <form id="farmWizardForm" novalidate>
        <p class="tiny" id="farmModalProgress" aria-live="polite">Step 1 of 6</p>
        <h2 id="farmModalTitle" style="margin:0 0 12px">Let’s get you online</h2>
        <div id="farmSteps">
          <section class="farm-step" data-step="connection-choice">
            <p class="farm-question">Let’s get you online—are you connecting this reTerminal to Wi‑Fi or Ethernet today?</p>
            <div class="chip-row" id="farmConnectionChoice" role="radiogroup" aria-label="Connection type">
              <button type="button" class="chip-option" data-value="wifi">Wi‑Fi</button>
              <button type="button" class="chip-option" data-value="ethernet">Ethernet</button>
            </div>
            <p class="tiny" style="margin-top:8px;color:#475569">Switch anytime—Wi‑Fi walks you through SSID, password, and a connection test.</p>
          </section>

          <section class="farm-step" data-step="wifi-select">
            <p class="farm-question">Great—let’s pick the Wi‑Fi network.</p>
            <div class="farm-step__stack">
              <!-- Wi-Fi Scanner (Step 2) -->
              <div id="wifiStep2Scanner" class="scanning-container" style="display: none;">
                <div class="scanning-radar"></div>
                <div class="scanning-text">Scanning for Wi-Fi networks (Step 2)</div>
                <div class="scanning-status">Please wait while we discover available networks for setup...</div>
              </div>
              <div class="row row--gap-xs row--center row--wrap">
                <button id="btnScanWifi" type="button" class="ghost">Scan again</button>
                <span id="wifiScanStatus" class="tiny" aria-live="polite"></span>
                <button id="btnManualSsid" type="button" class="ghost">Add hidden network</button>
              </div>
              <div id="wifiNetworkList" class="chip-grid" role="listbox" aria-label="Available Wi‑Fi networks"></div>
            </div>
          </section>

          <section class="farm-step" data-step="wifi-password">
            <p class="farm-question">Enter the password for <span id="wifiChosenSsid" class="inline-chip"></span>.</p>
            <div class="farm-step__stack">
              <input id="wifiPassword" type="password" autocomplete="new-password" placeholder="Wi‑Fi password" required>
              <label class="tiny" style="display:flex;align-items:center;gap:6px"><input id="wifiShowPassword" type="checkbox">Show password</label>
              <label class="tiny" style="display:flex;align-items:center;gap:6px">
                <input id="wifiReuseDevices" type="checkbox" checked>
                Use this network for device discovery
              </label>
            </div>
          </section>

          <section class="farm-step" data-step="wifi-test">
            <p class="farm-question">Testing that connection…</p>
            <div class="farm-step__stack">
              <!-- Wi-Fi Test Scanner (Step 4) -->
              <div id="wifiTestingIndicator" class="scanning-container" style="display: none;">
                <div class="scanning-radar"></div>
                <div class="scanning-text">Testing Wi-Fi Connection (Step 4)</div>
                <div class="scanning-status">Verifying network connectivity and internet access...</div>
              </div>
              <button id="btnTestWifi" type="button" class="primary">Test connection</button>
              <div id="wifiTestStatus" class="farm-review" aria-live="polite"></div>
            </div>
          </section>

          <section class="farm-step" data-step="location">
            <p class="farm-question">Where is this farm?</p>
            <div class="farm-step__stack">
              <input id="farmName" name="farmName" type="text" autocomplete="organization" placeholder="Farm name" required>
              
              <!-- Use Current Location moved to top -->
              <div style="display: flex; gap: 6px; align-items: center; margin: 8px 0; flex-wrap: wrap;">
                <button type="button" id="btnUseMyLocation" class="btn-secondary" style="font-size: 14px;" title="Uses your device's current location to automatically fill address and get GPS coordinates">🧭 Use Current Location</button>
                <span id="locationStatus" class="tiny" style="color: #666;"></span>
              </div>
              <div class="tiny" style="color:#666;margin-bottom:8px;line-height:1.3">
                <strong>🧭 Use Current Location:</strong> Uses your device's GPS to automatically fill in your current address and coordinates for subscription services
              </div>
              
              <p class="tiny" style="color:#64748b;margin:4px 0">Or enter your farm's address manually below (this information will be used for subscriptions):</p>
              <input id="farmAddress" type="text" autocomplete="street-address" placeholder="Street address">
              <div class="row row--gap-xs row--wrap">
                <input id="farmCity" type="text" autocomplete="address-level2" placeholder="City">
                <input id="farmState" type="text" autocomplete="address-level1" placeholder="State / Province" style="max-width:140px">
                <input id="farmPostal" type="text" autocomplete="postal-code" placeholder="Postal code" style="max-width:140px">
              </div>
              <div id="locationResults" class="location-results" style="display: none; margin-top: 8px;">
                <div class="tiny" style="margin-bottom: 4px; color: #666;">Select your farm location:</div>
                <div id="locationOptions"></div>
              </div>
              <div id="weatherDisplay" class="weather-display" style="display: none; margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                <div class="weather-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                  <span style="font-size: 18px;">🌤️</span>
                  <strong style="color: #333;">Current Weather</strong>
                </div>
                <div id="weatherContent"></div>
              </div>
              <label class="tiny" style="display:flex;align-items:center;gap:6px">
                Timezone
                <select id="farmTimezone" style="min-width:200px"></select>
              </label>
            </div>
          </section>

          <section class="farm-step" data-step="contact">
            <p class="farm-question">Who should we contact about this farm?</p>
            <div class="farm-step__stack">
              <input id="contactName" name="contactName" type="text" autocomplete="name" placeholder="Contact name" required>
              <input id="contactEmail" name="contactEmail" type="email" autocomplete="email" placeholder="Email address" required>
              <input id="contactPhone" name="contactPhone" type="tel" autocomplete="tel" placeholder="Phone number">
              <div style="display:flex;align-items:center;gap:8px">
                <input id="contactWebsite" name="contactWebsite" type="url" autocomplete="url" placeholder="Website (for branding)" style="border:2px solid var(--gr-accent);box-shadow:0 0 0 2px rgba(100, 199, 199, 0.1);flex:1">
                <button id="websiteBrandingButton" type="button" style="background:var(--gr-primary);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;white-space:nowrap;min-width:80px;opacity:0.5;transition:all 0.2s ease" disabled>
                  🎨 Enter
                </button>
              </div>
              <div id="brandingPreview" class="tiny branding-preview-card" style="margin-top:8px;padding:12px;background:var(--gr-bg);border:1px solid var(--gr-border);border-radius:6px;display:none;cursor:pointer;transition:all 0.2s ease" onclick="farmWizard.showBrandingModal()">
                <div style="color:var(--gr-primary);font-weight:600;margin-bottom:4px;display:flex;align-items:center;gap:6px">
                  🎨 Live Branding Preview 
                  <span style="font-size:10px;opacity:0.7;background:var(--gr-primary);color:white;padding:2px 6px;border-radius:10px">CLICK TO EXPAND</span>
                </div>
                <div id="brandingPreviewContent" style="color:var(--medium)">Enter farm name and website to see your branding...</div>
              </div>
            </div>
          </section>

          <section class="farm-step" data-step="spaces">
            <p class="farm-question">Add your spaces—rooms first, then zones within each room.</p>
            <div class="farm-step__stack">
              <div class="row row--gap-xs row--wrap">
                <input id="newRoomName" type="text" placeholder="Room name (e.g., Flower A)">
                <button id="btnAddRoom" type="button" class="ghost">Add room</button>
              </div>
              <div id="roomsEditor" class="farm-spaces" aria-live="polite"></div>
            </div>
          </section>

          <section class="farm-step" data-step="review">
            <p class="farm-question">Farm · Rooms · Zones — ready to save?</p>
            <div class="farm-review" id="farmReview"></div>
          </section>
        </div>

        <div class="row row--between mt-xl">
          <button id="farmPrev" type="button" class="ghost">Back</button>
          <div class="row row--gap-sm">
            <button id="farmNext" type="button" class="primary">Next</button>
            <button id="btnSaveFarm" type="submit" class="primary" style="display:none">Save Farm</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="deviceManager" class="device-manager" aria-hidden="true">
    <div class="device-manager__backdrop" id="deviceManagerBackdrop"></div>
    <div class="device-manager__window" role="dialog" aria-modal="true" aria-labelledby="deviceManagerTitle">
      <header class="device-manager__header">
        <div>
          <h2 id="deviceManagerTitle">Device Manager</h2>
          <p class="tiny" id="deviceManagerSubtitle">Scan Wi‑Fi, BLE, and MQTT sources to bring devices into the farm.</p>
        </div>
        <button type="button" id="deviceManagerClose" class="ghost" aria-label="Close">×</button>
      </header>
      <div class="device-manager__toolbar">
        <button id="btnRunDiscovery" type="button" class="primary">Run discovery</button>
        <span id="discoveryStatus" class="tiny" aria-live="polite"></span>
        <div class="chip-row" role="tablist" aria-label="Discovery filters">
          <button type="button" class="chip-option" data-filter="all" aria-selected="true">All</button>
          <button type="button" class="chip-option" data-filter="added">Added</button>
          <button type="button" class="chip-option" data-filter="ignored">Ignored</button>
        </div>
      </div>
      <div id="deviceDiscoveryResults" class="device-manager__results" aria-live="polite"></div>
      <footer class="device-manager__footer">
        <div id="deviceManagerSummary" class="tiny"></div>
        <button id="btnOpenAutomation" type="button" class="ghost">Open Automation Card</button>
      </footer>
    </div>
  </div>

  <footer id="planSummary" class="tiny" style="padding:12px;color:#475569"></footer>
  <div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
